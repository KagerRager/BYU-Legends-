<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BYU Cougar Legend Clicker</title>

  <!-- Google Fonts: Bebas Neue for varsity style -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Roboto:wght@400;700&display=swap" rel="stylesheet" />

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    if (typeof tailwind !== 'undefined') {
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'byu-navy': '#002E5D',
              'byu-blue': '#0062B8',
            },
            fontFamily: {
              varsity: ['"Bebas Neue"', 'Courier New', 'monospace'],
              body: ['Roboto', 'sans-serif'],
            },
          },
        },
      };
    }
  </script>

  <style>
    /* â”€â”€ Base reset / global â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; }
    body { font-family: 'Roboto', sans-serif; }

    /* â”€â”€ Float-up click animation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes floatUp {
      0%   { opacity: 1; transform: translateY(0) scale(1); }
      100% { opacity: 0; transform: translateY(-80px) scale(1.4); }
    }
    .float-label {
      position: fixed;
      pointer-events: none;
      font-family: 'Bebas Neue', monospace;
      font-size: 2rem;
      color: #FFD700;
      text-shadow: 0 2px 6px rgba(0,0,0,.6);
      animation: floatUp .9s ease-out forwards;
      z-index: 9999;
    }

    /* â”€â”€ Jersey click zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #jersey-btn {
      cursor: pointer;
      transition: transform .1s;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }
    #jersey-btn:active { transform: scale(.93); }

    /* â”€â”€ Legend card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .legend-card {
      transition: box-shadow .2s, transform .2s;
    }
    .legend-card:hover {
      box-shadow: 0 0 18px rgba(0,98,184,.7);
      transform: translateY(-2px);
    }

    /* â”€â”€ Tab button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tab-btn.active {
      background-color: #0062B8;
      color: #fff;
    }

    /* â”€â”€ Progress bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .prog-bar-inner {
      transition: width .4s ease;
      background: linear-gradient(90deg, #0062B8, #00a8ff);
    }

    /* â”€â”€ Prestige glow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes prestigePulse {
      0%, 100% { box-shadow: 0 0 12px 4px #FFD700; }
      50%       { box-shadow: 0 0 30px 12px #FFB300; }
    }
    .prestige-ready { animation: prestigePulse 1.5s ease-in-out infinite; }

    /* â”€â”€ Scrollbar (sidebar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .sidebar-scroll::-webkit-scrollbar { width: 6px; }
    .sidebar-scroll::-webkit-scrollbar-track { background: #001a35; }
    .sidebar-scroll::-webkit-scrollbar-thumb { background: #0062B8; border-radius: 3px; }

    /* â”€â”€ Mobile bottom-bar safe area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 767px) {
      #app { flex-direction: column; }
    }

    /* â”€â”€ Tailwind utility fallback (in case CDN is unavailable) â”€â”€ */
    .hidden { display: none !important; }

    /* â”€â”€ Critical layout fallbacks when Tailwind CDN is unavailable â”€â”€ */
    @media (min-width: 768px) { .md\:flex { display: flex !important; } }

    /* â”€â”€ Animated starfield background â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: -1;
      background: radial-gradient(ellipse at 20% 50%, rgba(0,98,184,.15) 0%, transparent 60%),
                  radial-gradient(ellipse at 80% 20%, rgba(255,215,0,.08) 0%, transparent 50%),
                  #002E5D;
      pointer-events: none;
    }

    /* â”€â”€ Combo counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes comboPop {
      0%   { transform: scale(1); }
      40%  { transform: scale(1.35); }
      100% { transform: scale(1); }
    }
    #combo-display {
      transition: color .2s;
    }
    #combo-display.pop { animation: comboPop .25s ease-out; }

    /* â”€â”€ Tier badge colors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tier-bronze  { border-color: #cd7f32 !important; }
    .tier-silver  { border-color: #C0C0C0 !important; }
    .tier-gold    { border-color: #FFD700 !important; }
    .tier-platinum{ border-color: #00e5ff !important; }
    .tier-diamond { border-color: #b9f2ff !important; box-shadow: 0 0 12px #00e5ff66; }
    .tier-legendary { border-color: #ff6600 !important; box-shadow: 0 0 18px #ff660088; }

    /* â”€â”€ Unlock flash â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes unlockFlash {
      0%,100% { opacity: 0; } 20%,80% { opacity: .6; }
    }
    .unlock-flash {
      position: fixed; inset: 0; z-index: 200;
      background: radial-gradient(circle, #FFD700 0%, transparent 70%);
      pointer-events: none;
      animation: unlockFlash .6s ease-out forwards;
    }

    /* â”€â”€ Auto-clicker section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .upgrade-card {
      transition: box-shadow .2s, transform .2s;
    }
    .upgrade-card:hover {
      box-shadow: 0 0 14px rgba(255,215,0,.4);
      transform: translateY(-1px);
    }

    /* â”€â”€ Active legend pulsing glow on jersey â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes jerseyGlow {
      0%,100% { filter: drop-shadow(0 0 8px rgba(0,98,184,.6)); }
      50%      { filter: drop-shadow(0 0 22px rgba(0,98,184,.95)); }
    }
    #jersey-svg.has-legend { animation: jerseyGlow 2s ease-in-out infinite; }

    /* â”€â”€ Passive income counter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @keyframes tickUp {
      0%   { opacity: 0; transform: translateY(0); }
      50%  { opacity: 1; }
      100% { opacity: 0; transform: translateY(-40px); }
    }
    .auto-tick {
      position: fixed; pointer-events: none;
      font-family: 'Bebas Neue', monospace;
      font-size: 1.1rem; color: #00e5ff;
      text-shadow: 0 1px 4px rgba(0,0,0,.5);
      animation: tickUp 1.2s ease-out forwards;
      z-index: 9998;
    }

    /* â”€â”€ Jersey customization swatches â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .color-swatch {
      width: 28px; height: 28px;
      border-radius: 5px;
      cursor: pointer;
      border: 2px solid rgba(255,255,255,0.15);
      transition: transform .15s, border-color .15s, box-shadow .15s;
      flex-shrink: 0;
    }
    .color-swatch:hover { transform: scale(1.2); border-color: rgba(255,255,255,0.5); }
    .color-swatch.swatch-selected { border-color: #FFD700 !important; box-shadow: 0 0 8px #FFD700; transform: scale(1.15); }

    /* â”€â”€ Mini jersey card hover glow â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .mini-jersey-wrap { transition: transform .15s, filter .15s; }
    .mini-jersey-wrap:hover { transform: scale(1.08); filter: drop-shadow(0 0 6px rgba(255,215,0,.5)); }
  </style>
</head>

<body class="bg-byu-navy min-h-screen text-white font-body">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOP HUD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<header class="bg-byu-blue border-b-4 border-white sticky top-0 z-50 shadow-lg">
  <div class="max-w-6xl mx-auto px-4 py-2 flex flex-wrap items-center justify-between gap-2">
    <!-- Title -->
    <h1 class="font-varsity text-3xl sm:text-4xl tracking-widest text-white drop-shadow">
      ğŸˆ BYU COUGAR LEGEND CLICKER
    </h1>

    <!-- Points & PPC -->
    <div class="flex gap-4 items-center">
      <div class="text-center">
        <div id="hud-points" class="font-varsity text-3xl text-yellow-300 leading-none">0</div>
        <div class="text-xs uppercase tracking-widest opacity-75">Cougar Points</div>
      </div>
      <div class="text-center">
        <div id="hud-ppc" class="font-varsity text-3xl text-white leading-none">1</div>
        <div class="text-xs uppercase tracking-widest opacity-75">Pts / Click</div>
      </div>
      <div class="text-center" id="hud-prestige-wrap">
        <div id="hud-prestige" class="font-varsity text-3xl text-yellow-300 leading-none">Ã—1</div>
        <div class="text-xs uppercase tracking-widest opacity-75">Prestige</div>
      </div>
      <div class="text-center" id="hud-pps-wrap">
        <div id="hud-pps" class="font-varsity text-3xl text-cyan-300 leading-none">0</div>
        <div class="text-xs uppercase tracking-widest opacity-75">Pts / Sec</div>
      </div>
      <div class="text-center">
        <div id="combo-display" class="font-varsity text-3xl text-orange-300 leading-none">x1</div>
        <div class="text-xs uppercase tracking-widest opacity-75">Combo</div>
      </div>
      <button onclick="Sound.toggle()" id="sound-btn"
              class="text-xl px-2 py-1 rounded border border-white/20 hover:bg-white/10 transition"
              title="Toggle sound" aria-label="Toggle sound">ğŸ”Š</button>
    </div>
  </div>
</header>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MAIN LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" class="flex max-w-6xl mx-auto px-4 py-6 gap-6 min-h-[calc(100vh-72px)]">

  <!-- â”€â”€â”€ LEFT: Click Zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main class="flex-1 flex flex-col items-center gap-6">

    <!-- Jersey Click Button -->
    <section
      id="jersey-btn"
      role="button"
      aria-label="Click to earn Cougar Points"
      class="relative flex flex-col items-center select-none"
      onclick="Game.handleClick(event)"
      onkeydown="if((event.key==='Enter'||event.key===' ')&&!event.repeat) Game.handleClick(event)"
      tabindex="0"
    >
      <!-- Jersey SVG â€“ updated dynamically by JS -->
      <svg id="jersey-svg" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 220 270"
           class="w-48 sm:w-64 md:w-72 drop-shadow-2xl">
        <defs>
          <linearGradient id="jersey-grad" x1="10%" y1="0%" x2="90%" y2="100%">
            <stop id="jersey-grad-light" offset="0%"   stop-color="#003D7A"/>
            <stop id="jersey-grad-dark"  offset="100%" stop-color="#001a35"/>
          </linearGradient>
          <filter id="jersey-drop-shadow" x="-8%" y="-4%" width="116%" height="116%">
            <feDropShadow dx="0" dy="5" stdDeviation="7" flood-color="#000" flood-opacity="0.45"/>
          </filter>
          <!-- Fabric mesh texture (perforated athletic jersey look) -->
          <pattern id="jersey-mesh-pat" x="0" y="0" width="5" height="5" patternUnits="userSpaceOnUse">
            <circle cx="2.5" cy="2.5" r="0.75" fill="rgba(255,255,255,0.065)"/>
          </pattern>
        </defs>
        <g id="jersey-body" filter="url(#jersey-drop-shadow)">
          <!-- Main body -->
          <path id="jersey-main"
                d="M20 60 L0 112 L32 118 L32 252 L188 252 L188 118 L220 112 L200 60
                   L155 38 C145 80 75 80 65 38 Z"
                fill="url(#jersey-grad)" stroke="#FFFFFF" stroke-width="2.5"/>
          <!-- Side stripe left -->
          <path id="jersey-stripe-l" d="M32 118 L56 118 L56 252 L32 252 Z" fill="#FFD700" opacity="0.9"/>
          <!-- Side stripe right -->
          <path id="jersey-stripe-r" d="M164 118 L188 118 L188 252 L164 252 Z" fill="#FFD700" opacity="0.9"/>
          <!-- Sleeve stripe left (primary) -->
          <rect id="jersey-sleeve-l" x="0" y="104" width="32" height="7" fill="#FFD700"/>
          <!-- Sleeve stripe right (primary) -->
          <rect id="jersey-sleeve-r" x="188" y="104" width="32" height="7" fill="#FFD700"/>
          <!-- Sleeve stripe left (secondary) -->
          <rect id="jersey-sleeve2-l" x="0" y="95" width="32" height="4" fill="#FFD700" opacity="0.5"/>
          <!-- Sleeve stripe right (secondary) -->
          <rect id="jersey-sleeve2-r" x="188" y="95" width="32" height="4" fill="#FFD700" opacity="0.5"/>
          <!-- Shoulder shading -->
          <path d="M20 60 L0 112 L32 118 L65 38 Z" fill="rgba(255,255,255,0.07)" stroke="none"/>
          <path d="M200 60 L220 112 L188 118 L155 38 Z" fill="rgba(255,255,255,0.07)" stroke="none"/>
          <!-- Collar shadow depth -->
          <path id="jersey-collar-fill"
                d="M87 38 Q110 66 133 38 Q120 51 110 56 Q100 51 87 38 Z" fill="#001020" opacity="0.88"/>
          <!-- Collar rim shadow for depth -->
          <path d="M87 39 Q110 65 133 39" fill="none" stroke="rgba(0,0,0,0.55)" stroke-width="2.5" stroke-linecap="round"/>
          <!-- Collar outline -->
          <path id="jersey-collar"
                d="M85 38 Q110 67 135 38" fill="none" stroke="#FFFFFF" stroke-width="4" stroke-linecap="round"/>
          <!-- Collar stitching line -->
          <path d="M89 42 Q110 63 131 42" fill="none" stroke="rgba(255,255,255,0.28)" stroke-width="0.8" stroke-dasharray="2.5,2" stroke-linecap="round"/>
          <!-- Fabric mesh texture overlay on entire jersey body -->
          <path d="M20 60 L0 112 L32 118 L32 252 L188 252 L188 118 L220 112 L200 60 L155 38 C145 80 75 80 65 38 Z"
                fill="url(#jersey-mesh-pat)" stroke="none" pointer-events="none"/>
          <!-- Shoulder seam stitching left -->
          <path d="M21 62 L33 119" stroke="rgba(255,255,255,0.16)" stroke-width="0.9" stroke-dasharray="3,3" fill="none"/>
          <!-- Shoulder seam stitching right -->
          <path d="M199 62 L187 119" stroke="rgba(255,255,255,0.16)" stroke-width="0.9" stroke-dasharray="3,3" fill="none"/>
          <!-- Bottom hem double stitch -->
          <path d="M35 249 L185 249" stroke="rgba(255,255,255,0.16)" stroke-width="0.8" stroke-dasharray="4,3" fill="none"/>
          <path d="M37 245 L183 245" stroke="rgba(255,255,255,0.08)" stroke-width="0.5" stroke-dasharray="4,3" fill="none"/>
          <!-- Sleeve hem stitching -->
          <path d="M1 110 L31 110" stroke="rgba(255,255,255,0.16)" stroke-width="0.8" stroke-dasharray="2,2" fill="none"/>
          <path d="M189 110 L219 110" stroke="rgba(255,255,255,0.16)" stroke-width="0.8" stroke-dasharray="2,2" fill="none"/>
          <!-- Side stripe inner shadow lines for 3D depth -->
          <path d="M56 118 L56 252" stroke="rgba(0,0,0,0.22)" stroke-width="1.2" fill="none"/>
          <path d="M164 118 L164 252" stroke="rgba(0,0,0,0.22)" stroke-width="1.2" fill="none"/>
          <!-- Chest panel highlight (subtle 3D effect) -->
          <path d="M67 44 C77 78 100 87 110 90 C120 87 143 78 153 44"
                fill="none" stroke="rgba(255,255,255,0.045)" stroke-width="9" stroke-linecap="round"/>
          <!-- Lower body shadow panel -->
          <path d="M32 200 L32 252 L188 252 L188 200 Z" fill="rgba(0,0,0,0.1)" stroke="none"/>
        </g>
        <!-- Jersey number (dynamic) -->
        <text id="jersey-number" x="110" y="177" text-anchor="middle"
              font-family="'Bebas Neue',monospace" font-size="75" font-weight="bold"
              fill="#FFD700" stroke="#002E5D" stroke-width="3" paint-order="stroke">?</text>
        <!-- Player name strip background -->
        <rect id="jersey-namestrip" x="32" y="202" width="156" height="18" fill="#FFD700" opacity="0.15" rx="2"/>
        <!-- Player name text (dynamic) -->
        <text id="jersey-name-text" x="110" y="215" text-anchor="middle"
              font-family="'Bebas Neue',monospace" font-size="12" letter-spacing="3"
              fill="#FFD700"></text>
        <!-- BYU wordmark -->
        <text x="110" y="248" text-anchor="middle"
              font-family="'Bebas Neue',monospace" font-size="20"
              fill="#FFD700" letter-spacing="8">BYU</text>
      </svg>

      <p class="text-white/60 text-sm mt-2 animate-pulse">Tap the jersey to earn points!</p>
    </section>

    <!-- Active legend info -->
    <div id="active-legend-info" class="text-center hidden">
      <div id="active-name" class="font-varsity text-2xl text-yellow-300"></div>
      <div id="active-title" class="text-sm text-white/70 italic"></div>
    </div>

    <!-- Prestige Button -->
    <button
      id="prestige-btn"
      onclick="Game.prestige()"
      class="hidden font-varsity text-xl px-8 py-3 rounded-lg bg-yellow-400 text-byu-navy
             border-4 border-yellow-200 hover:bg-yellow-300 transition prestige-ready"
      aria-label="Prestige - reset and double points"
    >
      â­ PRESTIGE â€” RESET &amp; DOUBLE POINTS â­
    </button>

    <!-- Next unlock progress -->
    <div id="next-unlock-wrap" class="w-full max-w-sm">
      <div class="flex justify-between text-xs text-white/60 mb-1">
        <span id="next-unlock-label">Next: Gifford Nielsen</span>
        <span id="next-unlock-pct">0%</span>
      </div>
      <div class="h-3 bg-white/10 rounded-full overflow-hidden">
        <div id="next-unlock-bar" class="prog-bar-inner h-full rounded-full" style="width:0%"></div>
      </div>
    </div>

    <!-- â”€â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="w-full max-w-sm">
      <div class="flex gap-1 mb-3">
        <button class="tab-btn active flex-1 py-2 rounded-t font-varsity tracking-wide text-sm border border-white/20"
                onclick="Game.showTab('gallery')" id="tab-gallery">GALLERY</button>
        <button class="tab-btn flex-1 py-2 rounded-t font-varsity tracking-wide text-sm border border-white/20"
                onclick="Game.showTab('upgrades')" id="tab-upgrades">UPGRADES</button>
        <button class="tab-btn flex-1 py-2 rounded-t font-varsity tracking-wide text-sm border border-white/20"
                onclick="Game.showTab('collection')" id="tab-collection">COLLECTION</button>
        <button class="tab-btn flex-1 py-2 rounded-t font-varsity tracking-wide text-sm border border-white/20"
                onclick="Game.showTab('stats')" id="tab-stats">STATS</button>
        <button class="tab-btn flex-1 py-2 rounded-t font-varsity tracking-wide text-sm border border-white/20"
                onclick="Game.showTab('customize')" id="tab-customize">ğŸ¨</button>
        <button class="tab-btn flex-1 py-2 rounded-t font-varsity tracking-wide text-sm border border-white/20"
                onclick="Game.showTab('minigames')" id="tab-minigames">ğŸ®</button>
        <button class="tab-btn flex-1 py-2 rounded-t font-varsity tracking-wide text-sm border border-white/20"
                onclick="Game.showTab('leaderboard')" id="tab-leaderboard">ğŸ†</button>
      </div>

      <!-- Gallery panel -->
      <div id="panel-gallery"></div>

      <!-- Upgrades panel (hidden by default) -->
      <div id="panel-upgrades" class="hidden"></div>

      <!-- Collection panel (hidden by default) -->
      <div id="panel-collection" class="hidden"></div>

      <!-- Stats panel (hidden by default) -->
      <div id="panel-stats" class="hidden"></div>

      <!-- Customize panel (hidden by default) -->
      <div id="panel-customize" class="hidden"></div>

      <!-- Mini Games panel (hidden by default) -->
      <div id="panel-minigames" class="hidden"></div>

      <!-- Leaderboard panel (hidden by default) -->
      <div id="panel-leaderboard" class="hidden"></div>
    </div>

  </main>

  <!-- â”€â”€â”€ RIGHT: Legend Gallery sidebar (md+) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside class="hidden md:flex flex-col w-72 gap-4 sidebar-scroll overflow-y-auto max-h-[calc(100vh-90px)]">
    <h2 class="font-varsity text-2xl tracking-widest border-b border-white/20 pb-2">LEGEND GALLERY</h2>
    <div id="sidebar-gallery"></div>
  </aside>

</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GAME SCRIPT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const LEGENDS = [
  {
    id: 'nielsen',
    name: 'Gifford Nielsen',
    number: '14',
    cost: 10,
    ppc: 2,           // points per click when active
    era: 'late-70s',
    title: 'The Bridge Builder',
    description: 'Two-time Western Athletic Conference MVP and the first BYU quarterback to earn national recognition, Nielsen was the bridge between BYU\'s early days and its dynasty era.',
    stat1Label: 'WAC MVPs',  stat1: '2',
    stat2Label: 'TD passes (career)', stat2: '51',
    jerseyFill: '#002E5D',
    jerseyStroke: '#FFFFFF',
    accentColor: '#FFFFFF',
    tier: 'bronze',
  },
  {
    id: 'ainge',
    name: 'Danny Ainge',
    number: '22',
    cost: 50,
    ppc: 4,
    title: 'The Multi-Sport Icon',
    description: 'A two-sport All-American who played baseball for the Toronto Blue Jays while being BYU\'s starting quarterback, Ainge later became an NBA All-Star and championship-winning executive.',
    stat1Label: 'Sports played professionally', stat1: '2',
    stat2Label: 'NBA rings (as exec)', stat2: '2',
    jerseyFill: '#001a3a',
    jerseyStroke: '#0062B8',
    accentColor: '#0062B8',
    tier: 'bronze',
  },
  {
    id: 'young',
    name: 'Steve Young',
    number: '8',
    cost: 150,
    ppc: 8,
    title: 'The Super Bowl MVP',
    description: 'Finished his BYU career as the top-rated passer in NCAA history. Won Super Bowl XXIX MVP with the 49ers, throwing a record 6 TD passes, and was inducted into the Pro Football Hall of Fame.',
    stat1Label: 'Super Bowl MVPs', stat1: '1',
    stat2Label: 'Career QBR (NFL passer rating)', stat2: '96.8',
    jerseyFill: '#002E5D',
    jerseyStroke: '#FFD700',
    accentColor: '#FFD700',
    tier: 'silver',
  },
  {
    id: 'detmer',
    name: 'Ty Detmer',
    number: '14', // Both Nielsen and Detmer wore #14 â€” historically accurate for BYU's retired numbers
    cost: 500,
    ppc: 16,
    title: 'The Heisman Trophy Winner',
    description: 'Won the 1990 Heisman Trophy by the largest margin in history at the time, set 59 NCAA records, and led BYU to back-to-back WAC championships. His passing records stood for decades.',
    stat1Label: 'NCAA records set', stat1: '59',
    stat2Label: 'Heisman margin (pts)', stat2: 'Record',
    jerseyFill: '#001020',
    jerseyStroke: '#FFD700',
    accentColor: '#FFD700',
    tier: 'gold',
  },
  {
    id: 'wilson_marc',
    name: 'Marc Wilson',
    number: '6',
    cost: 800,
    ppc: 22,
    pps: 1,
    era: 'late-70s',
    title: 'The Architect',
    description: 'A key building block of BYU\'s passing dynasty, Wilson set the stage for the record-breaking quarterbacks that followed. Led BYU to a 12-1 record and Holiday Bowl victory in 1979.',
    stat1Label: 'WAC Championships', stat1: '2',
    stat2Label: 'Holiday Bowl W', stat2: '1979',
    jerseyFill: '#002E5D',
    jerseyStroke: '#C0C0C0',
    accentColor: '#C0C0C0',
    tier: 'silver',
  },
  {
    id: 'mcmahon',
    name: 'Jim McMahon',
    number: '9',
    cost: 2000,
    ppc: 45,
    pps: 2,
    era: 'early-80s',
    title: 'The Wild One',
    description: 'One of the most electrifying quarterbacks in college football history. Set 70 NCAA records at BYU and went on to lead the Chicago Bears to a Super Bowl XX title in the 1985 season.',
    stat1Label: 'NCAA records set', stat1: '70',
    stat2Label: 'Super Bowl rings', stat2: '1',
    jerseyFill: '#001a3a',
    jerseyStroke: '#FF4500',
    accentColor: '#FF4500',
    tier: 'gold',
  },
  {
    id: 'bosco',
    name: 'Robbie Bosco',
    number: '6',
    cost: 5000,
    ppc: 90,
    pps: 4,
    era: 'mid-80s',
    title: 'The National Champion',
    description: 'Led BYU to its only national championship in 1984, finishing 13-0 and winning the Holiday Bowl MVP. Played through injury to cement his legacy as one of the program\'s greatest leaders.',
    stat1Label: 'National Titles', stat1: '1',
    stat2Label: 'Final season record', stat2: '13-0',
    jerseyFill: '#002E5D',
    jerseyStroke: '#FFD700',
    accentColor: '#FFD700',
    tier: 'platinum',
  },
  {
    id: 'unga',
    name: 'Harvey Unga',
    number: '25',
    cost: 12000,
    ppc: 180,
    pps: 8,
    era: 'late-2000s',
    title: 'Thunder Legs',
    description: 'BYU\'s all-time leading rusher with over 3,900 career yards. A powerful back who combined bruising power with surprising finesse, Unga was the heart of BYU\'s ground game for four seasons.',
    stat1Label: 'Career rushing yards', stat1: '3,926',
    stat2Label: 'Career rushing TDs', stat2: '43',
    jerseyFill: '#001a3a',
    jerseyStroke: '#00a8ff',
    accentColor: '#00a8ff',
    tier: 'silver',
  },
  {
    id: 'max_hall',
    name: 'Max Hall',
    number: '15',
    cost: 15000,
    ppc: 270,
    pps: 11,
    era: 'late-2000s',
    title: 'The BCS Qualifier',
    description: 'Led BYU to back-to-back Las Vegas Bowl victories and delivered a legendary rivalry performance in 2009. Hall set multiple BYU passing records and was one of the most clutch quarterbacks in program history.',
    stat1Label: 'Career passing TDs', stat1: '82',
    stat2Label: 'Career passing yards', stat2: '9,467',
    jerseyFill: '#002E5D',
    jerseyStroke: '#FFD700',
    accentColor: '#FFD700',
    tier: 'gold',
  },
  {
    id: 'christensen',
    name: 'Todd Christensen',
    number: '46',
    cost: 25000,
    ppc: 420,
    pps: 18,
    era: 'late-70s',
    title: 'The NFL All-Pro',
    description: 'A BYU tight end who transformed into one of the NFL\'s most productive receivers with the Oakland/LA Raiders. Led the league in receptions twice and was a five-time Pro Bowler, earning a Super Bowl ring in Super Bowl XVIII.',
    stat1Label: 'Pro Bowl selections', stat1: '5',
    stat2Label: 'NFL receiving titles', stat2: '2',
    jerseyFill: '#1a1a1a',
    jerseyStroke: '#C0C0C0',
    accentColor: '#C0C0C0',
    tier: 'gold',
  },
  {
    id: 'collie',
    name: 'Austin Collie',
    number: '17',
    cost: 30000,
    ppc: 360,
    pps: 15,
    era: 'mid-2000s',
    title: 'The Clutch Receiver',
    description: 'The ultimate third-down target, Collie\'s legendary work ethic and precise route-running made him BYU\'s go-to receiver. His famous "faith" comment after a miraculous catch became part of BYU lore.',
    stat1Label: 'Career receiving yards', stat1: '2,547',
    stat2Label: 'Career receiving TDs', stat2: '28',
    jerseyFill: '#002E5D',
    jerseyStroke: '#ffffff',
    accentColor: '#ffffff',
    tier: 'gold',
  },
  {
    id: 'staley',
    name: 'Luke Staley',
    number: '21',
    cost: 60000,
    ppc: 800,
    pps: 32,
    era: 'early-2000s',
    title: 'The Heisman Contender',
    description: 'One of the most electric running backs in BYU history. Rushed for 1,596 yards and 19 touchdowns in 2001, finishing 5th in Heisman Trophy voting. His devastating combination of power and speed made him nearly unstoppable.',
    stat1Label: '2001 rushing yards', stat1: '1,596',
    stat2Label: '2001 rushing TDs', stat2: '19',
    jerseyFill: '#002E5D',
    jerseyStroke: '#FFD700',
    accentColor: '#FFD700',
    tier: 'platinum',
  },
  {
    id: 'van_noy',
    name: 'Kyle Van Noy',
    number: '3',
    cost: 75000,
    ppc: 720,
    pps: 30,
    era: 'early-2010s',
    title: 'The Defensive Legend',
    description: 'A two-time All-American linebacker who terrorized opposing offenses with elite pass-rushing ability and instincts. Went on to win two Super Bowl rings with the New England Patriots.',
    stat1Label: 'Super Bowl rings (NFL)', stat1: '2',
    stat2Label: 'Career NFL sacks', stat2: '40+',
    jerseyFill: '#001020',
    jerseyStroke: '#C0C0C0',
    accentColor: '#C0C0C0',
    tier: 'platinum',
  },
  {
    id: 'vai_sikahema',
    name: 'Vai Sikahema',
    number: '28',
    cost: 100000,
    ppc: 900,
    pps: 38,
    era: 'mid-80s',
    title: 'The Return Specialist',
    description: 'A key member of BYU\'s 1984 national championship team, Sikahema became the first Tongan-born player in the NFL. His explosive kick returns and fierce determination made him a fan favorite and BYU legend.',
    stat1Label: 'National Championships', stat1: '1',
    stat2Label: 'NFL seasons played', stat2: '7',
    jerseyFill: '#001020',
    jerseyStroke: '#FFD700',
    accentColor: '#FFD700',
    tier: 'platinum',
  },
  {
    id: 'lewis',
    name: 'Chad Lewis',
    number: '83',
    cost: 175000,
    ppc: 1400,
    pps: 60,
    era: 'mid-90s',
    title: 'The Pro Bowler',
    description: 'One of the best tight ends in BYU history, Lewis earned three Pro Bowl selections as an Eagle and played a key role in Philadelphia\'s Super Bowl XXXIX run, despite suffering a broken foot.',
    stat1Label: 'Pro Bowl selections', stat1: '3',
    stat2Label: 'BYU career TDs', stat2: '24',
    jerseyFill: '#002E5D',
    jerseyStroke: '#00e5ff',
    accentColor: '#00e5ff',
    tier: 'diamond',
  },
  {
    id: 'bradley',
    name: 'Shawn Bradley',
    number: '44',
    cost: 300000,
    ppc: 4500,
    pps: 200,
    era: 'early-90s',
    title: 'The 7-Foot Giant',
    description: 'At 7\'6", Bradley is the most physically imposing athlete in BYU history. After averaging 7.7 blocks per game at BYU, he was selected #2 overall in the 1993 NBA Draft by the Philadelphia 76ers and played 14 seasons in the NBA.',
    stat1Label: 'BYU blocks per game', stat1: '7.7',
    stat2Label: 'NBA Draft pick', stat2: '#2 Overall',
    jerseyFill: '#003087',
    jerseyStroke: '#C60C30',
    accentColor: '#FFD700',
    tier: 'diamond',
  },
  {
    id: 'taysom',
    name: 'Taysom Hill',
    number: '4',
    cost: 450000,
    ppc: 2800,
    pps: 120,
    era: 'mid-2010s',
    title: 'The Swiss Army Knife',
    description: 'The most versatile player in BYU history: quarterback, runner, receiver, punter, and kick returner. Taysom Hill\'s unique skillset made him a nightmare to defend, a tradition he continued in the NFL.',
    stat1Label: 'Career rushing TDs', stat1: '30',
    stat2Label: 'Positions played', stat2: '5+',
    jerseyFill: '#001a3a',
    jerseyStroke: '#FFD700',
    accentColor: '#FFD700',
    tier: 'diamond',
  },
  {
    id: 'lavell',
    name: 'LaVell Edwards',
    number: '1',
    cost: 1200000,
    ppc: 6000,
    pps: 260,
    era: '1972-2000',
    title: 'Architect of a Dynasty',
    description: 'The legendary head coach who built BYU into a national powerhouse. His 29-year career produced a national championship, 19 conference titles, and 257 wins. Inducted into the College Football Hall of Fame.',
    stat1Label: 'Career wins', stat1: '257',
    stat2Label: 'Conference titles', stat2: '19',
    jerseyFill: '#002E5D',
    jerseyStroke: '#FFD700',
    accentColor: '#FFD700',
    tier: 'legendary',
  },
  {
    id: 'zach',
    name: 'Zach Wilson',
    number: '1',
    cost: 3000000,
    ppc: 12000,
    pps: 500,
    era: 'early-2020s',
    title: 'The First-Round Pick',
    description: 'The most physically gifted BYU quarterback in the modern era. His off-platform throws, arm strength, and dual-threat ability led to a historic 2020 season and the #2 overall pick in the 2021 NFL Draft.',
    stat1Label: '2020 completion %', stat1: '73.5',
    stat2Label: 'NFL Draft pick', stat2: '#2 Overall',
    jerseyFill: '#001020',
    jerseyStroke: '#00e5ff',
    accentColor: '#00e5ff',
    tier: 'legendary',
  },
  {
    id: 'bronco',
    name: 'Bronco Mendenhall',
    number: '00',
    cost: 8000000,
    ppc: 25000,
    pps: 1000,
    era: '2005-2015',
    title: 'The Defensive Mastermind',
    description: 'Transformed BYU into a consistent national contender as head coach from 2005 to 2015. Won 99 games, led BYU to 10 bowl appearances, and built elite defenses that became the hallmark of the program.',
    stat1Label: 'Career wins at BYU', stat1: '99',
    stat2Label: 'Bowl game appearances', stat2: '10',
    jerseyFill: '#002E5D',
    jerseyStroke: '#FFFFFF',
    accentColor: '#FFFFFF',
    tier: 'legendary',
  },
  {
    id: 'jimmer',
    name: 'Jimmer Fredette',
    number: '32',
    cost: 20000000,
    ppc: 50000,
    pps: 2000,
    era: 'early-2010s',
    title: 'The Jimmer Effect',
    description: 'The most electrifying scorer in BYU basketball history. Led the nation in scoring in 2011 at 28.9 ppg, won the Naismith and Wooden Awards, and invented the "Jimmer Range" â€” a shooting zone so far beyond the arc it had to be named after him. A basketball legend for the ages.',
    stat1Label: '2011 scoring avg (ppg)', stat1: '28.9',
    stat2Label: 'BYU career points', stat2: '2,599',
    jerseyFill: '#002E5D',
    jerseyStroke: '#FFD700',
    accentColor: '#FFD700',
    tier: 'legendary',
  },
];

const UPGRADES = [
  { id: 'auto1', name: 'Team Trainer', desc: '+5 pts/sec passively', cost: 200,   pps: 5   },
  { id: 'auto2', name: 'Scout Team',   desc: '+20 pts/sec passively', cost: 1500,  pps: 20  },
  { id: 'auto3', name: 'Film Room',    desc: '+80 pts/sec passively', cost: 8000,  pps: 80  },
  { id: 'auto4', name: 'Recruit Camp', desc: '+300 pts/sec passively', cost: 40000, pps: 300 },
  { id: 'auto5', name: 'Dynasty Mode', desc: '+1,500 pts/sec passively', cost: 250000, pps: 1500 },
  { id: 'auto6', name: 'LaVell Edwards Stadium', desc: '+8,000 pts/sec passively', cost: 2000000, pps: 8000 },
  { id: 'auto7', name: 'BYU Legacy Campus', desc: '+40,000 pts/sec passively', cost: 15000000, pps: 40000 },
];

const ACHIEVEMENTS = [
  { id: 'first_click',   name: 'First Step',        desc: 'Click the jersey once',              icon: 'ğŸ‘Ÿ', reward: 5,     check: s => s.clickCount >= 1 },
  { id: 'clicks_100',    name: 'The Century',        desc: '100 total clicks',                   icon: 'ğŸ’¯', reward: 100,   check: s => s.clickCount >= 100 },
  { id: 'clicks_1000',   name: 'Dedicated Fan',      desc: '1,000 total clicks',                 icon: 'ğŸ¤™', reward: 1000,  check: s => s.clickCount >= 1000 },
  { id: 'clicks_10000',  name: 'True Cougar',        desc: '10,000 total clicks',                icon: 'ğŸ’ª', reward: 10000, check: s => s.clickCount >= 10000 },
  { id: 'first_legend',  name: 'Legend Born',        desc: 'Unlock your first legend',           icon: 'ğŸ†', reward: 50,    check: s => s.unlockedIds.length >= 1 },
  { id: 'five_legends',  name: 'Starting Lineup',    desc: 'Unlock 5 legends',                   icon: 'â­', reward: 2000,  check: s => s.unlockedIds.length >= 5 },
  { id: 'ten_legends',   name: 'Hall of Fame Roster',desc: 'Unlock 10 legends',                  icon: 'ğŸ…', reward: 15000, check: s => s.unlockedIds.length >= 10 },
  { id: 'all_legends',   name: 'BYU Hall of Fame',   desc: 'Unlock every legend',                icon: 'ğŸŒŸ', reward: 25000, check: s => s.unlockedIds.length >= LEGENDS.length },
  { id: 'first_upgrade', name: 'Team Builder',       desc: 'Buy your first auto upgrade',        icon: 'ğŸ“‹', reward: 200,   check: s => (s.purchasedUpgrades||[]).length >= 1 },
  { id: 'all_upgrades',  name: 'Dynasty Champion',   desc: 'Own every auto upgrade',             icon: 'ğŸŸï¸', reward: 10000, check: s => (s.purchasedUpgrades||[]).length >= UPGRADES.length },
  { id: 'prestige1',     name: 'Cougar Legend',      desc: 'Prestige for the first time',        icon: 'ğŸŒ ', reward: 5000,  check: s => s.prestigeLevel >= 1 },
  { id: 'hot_streak',    name: 'Hot Streak',         desc: 'Reach a Ã—1.75 combo multiplier',   icon: 'ğŸ”¥', reward: 500,   check: s => (s.maxComboLevel||0) >= 3 },
  { id: 'daily',         name: 'Daily Devotion',     desc: 'Return on a new day for a bonus',   icon: 'ğŸ“…', reward: 0,     check: s => (s.dailyBonusClaimed||0) >= 1 },
  { id: 'leaderboard1',  name: 'On the Board',       desc: 'Submit your score to the leaderboard', icon: 'ğŸ“Š', reward: 500, check: s => (s.leaderboardSubmits||0) >= 1 },
  { id: 'minigame_10',   name: 'Mini-Game Addict',   desc: 'Play any mini game 10 times',       icon: 'ğŸ®', reward: 2000,  check: s => (s.miniGamesPlayed||0) >= 10 },
];

const MAX_PRESTIGE_LEVEL = 10; // prestige caps at Ã—1024 (2^10)
const DAILY_BONUS_BASE = 50;   // base Cougar Points awarded per daily login

// Hail Mary mini-game reward tiers
const HM_TIERS = [
  { throws: 30, bonus: 5000,  msg: 'ğŸˆ LEGENDARY! 30+ throws!' },
  { throws: 25, bonus: 2500,  msg: 'ğŸŒŸ INCREDIBLE! 25+ throws!' },
  { throws: 20, bonus: 1200,  msg: 'ğŸ¯ TOUCHDOWN! 20+ throws!' },
  { throws: 15, bonus: 600,   msg: 'âš¡ Great arm! 15+ throws!' },
  { throws: 10, bonus: 250,   msg: 'ğŸ‘ Solid effort!' },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const State = (() => {
  const SAVE_KEY = 'byu_clicker_v2';
  const SAVE_KEY_V1 = 'byu_clicker_v1';

  const defaults = () => ({
    points: 0,
    totalPoints: 0,        // all-time clicks (not reset on prestige)
    unlockedIds: [],
    activeId: null,
    prestigeLevel: 0,      // number of prestiges done
    clickCount: 0,         // session clicks
    prestigeMultiplier: 1, // 2^prestigeLevel
    purchasedUpgrades: [], // auto-clicker upgrade ids
    soundEnabled: true,    // sound on/off
    jerseyCustomPrimary: '#002E5D', // custom jersey primary color
    jerseyCustomAccent:  '#FFD700', // custom jersey accent/stripe color
    earnedAchievements: [], // achievement ids earned
    maxComboLevel: 0,        // highest combo level ever reached
    lastLoginDate: '',       // YYYY-MM-DD of last visit
    dailyBonusClaimed: 0,    // total number of daily bonuses claimed
    leaderboardSubmits: 0,   // times the player submitted their score
    miniGamesPlayed: 0,      // total mini game rounds played
  });

  let _state = defaults();

  const save = () => {
    try { localStorage.setItem(SAVE_KEY, JSON.stringify(_state)); } catch (e) {
      console.warn('BYU Clicker: could not save progress â€”', e.message);
    }
  };

  const load = () => {
    try {
      // Try v2 first, then migrate v1
      const raw = localStorage.getItem(SAVE_KEY) || localStorage.getItem(SAVE_KEY_V1);
      if (raw) _state = { ...defaults(), ...JSON.parse(raw) };
      save(); // Persist as v2
    } catch {}
  };

  const get = () => _state;

  const update = (patch) => {
    Object.assign(_state, patch);
    save();
  };

  return { get, update, load, save, defaults };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOUND (Web Audio API â€” no external files)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Sound = (() => {
  let _ctx = null;
  const _ctx$ = () => {
    if (!_ctx) _ctx = new (window.AudioContext || window.webkitAudioContext)();
    return _ctx;
  };

  const _note = (freq, type, vol, start, dur) => {
    try {
      const ac = _ctx$();
      const o = ac.createOscillator();
      const g = ac.createGain();
      o.type = type;
      o.frequency.setValueAtTime(freq, start);
      g.gain.setValueAtTime(vol, start);
      g.gain.exponentialRampToValueAtTime(0.0001, start + dur);
      o.connect(g); g.connect(ac.destination);
      o.start(start); o.stop(start + dur);
    } catch (_) {}
  };

  const _play = (fn) => {
    if (!State.get().soundEnabled) return;
    fn();
  };

  const click = () => _play(() => {
    const ac = _ctx$(); const t = ac.currentTime;
    _note(700, 'sine', 0.25, t, 0.08);
    _note(400, 'sine', 0.15, t + 0.04, 0.1);
  });

  const combo = (level) => _play(() => {
    const ac = _ctx$(); const t = ac.currentTime;
    const freq = Math.min(1200, 300 + level * 80);
    _note(freq, 'sine', 0.2, t, 0.15);
  });

  const unlock = () => _play(() => {
    const ac = _ctx$(); const t = ac.currentTime;
    [523, 659, 784, 1047].forEach((f, i) => _note(f, 'sine', 0.28, t + i * 0.1, 0.25));
  });

  const prestige = () => _play(() => {
    const ac = _ctx$(); const t = ac.currentTime;
    [523, 659, 784, 1047, 1319, 1568].forEach((f, i) => _note(f, 'square', 0.18, t + i * 0.13, 0.35));
  });

  const toggle = () => {
    const enabled = !State.get().soundEnabled;
    State.update({ soundEnabled: enabled });
    document.getElementById('sound-btn').textContent = enabled ? 'ğŸ”Š' : 'ğŸ”‡';
  };

  return { click, combo, unlock, prestige, toggle };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PARTICLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Particles = (() => {
  const COLORS = ['#FFD700', '#0062B8', '#ffffff', '#FFB300', '#00e5ff'];
  const spawn = (x, y, count = 8) => {
    for (let i = 0; i < count; i++) {
      const el = document.createElement('div');
      const angle = (Math.PI * 2 * i / count) + (Math.random() - 0.5) * 0.8;
      const speed = 55 + Math.random() * 70;
      const dx = Math.cos(angle) * speed;
      const dy = Math.sin(angle) * speed;
      const size = 4 + Math.random() * 5;
      const color = COLORS[Math.floor(Math.random() * COLORS.length)];
      el.style.cssText = `position:fixed;pointer-events:none;z-index:9998;
        left:${x}px;top:${y}px;width:${size}px;height:${size}px;
        background:${color};border-radius:50%;
        transform:translate(-50%,-50%);
        transition:transform .65s ease-out,opacity .65s ease-out;`;
      document.body.appendChild(el);
      requestAnimationFrame(() => {
        el.style.transform = `translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`;
        el.style.opacity = '0';
      });
      setTimeout(() => el.remove(), 750);
    }
  };
  const flash = () => {
    const el = document.createElement('div');
    el.className = 'unlock-flash';
    document.body.appendChild(el);
    setTimeout(() => el.remove(), 700);
  };
  return { spawn, flash };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMBO TRACKER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Combo = (() => {
  let _count = 0;
  let _timer = null;
  const RESET_MS = 2000; // idle time (ms) before combo count resets
  // Click thresholds to reach each combo tier (index = tier level)
  const LEVELS = [1, 3, 6, 10, 15, 20];

  const level = () => {
    for (let i = LEVELS.length - 1; i >= 0; i--) {
      if (_count >= LEVELS[i]) return i;
    }
    return 0;
  };
  const multiplier = () => 1 + level() * 0.25;

  const register = () => {
    _count++;
    clearTimeout(_timer);
    _timer = setTimeout(() => { _count = 0; _updateDisplay(); }, RESET_MS);
    _updateDisplay();
    const lvl = level();
    if (lvl > 0) Sound.combo(lvl);
    // Track max combo level reached for achievements
    const s = State.get();
    if (lvl > (s.maxComboLevel || 0)) State.update({ maxComboLevel: lvl });
    return multiplier();
  };

  const _updateDisplay = () => {
    const el = document.getElementById('combo-display');
    if (!el) return;
    const m = multiplier();
    el.textContent = `x${m.toFixed(2)}`;
    el.style.color = _count >= LEVELS[4] ? '#ff6600' : _count >= LEVELS[2] ? '#FFD700' : '#fdba74';
    el.classList.remove('pop');
    void el.offsetWidth; // Force browser reflow so removing+adding the class restarts the CSS animation
    el.classList.add('pop');
  };

  return { register, multiplier };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UI HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const UI = (() => {

  const $ = (id) => document.getElementById(id);

  /* â”€â”€ HUD â”€â”€ */
  const updateHUD = () => {
    const s = State.get();
    const pts = Math.floor(s.points);
    const ppc = currentPPC();
    const pps = currentPPS();
    $('hud-points').textContent = pts.toLocaleString();
    $('hud-ppc').textContent    = ppc;
    $('hud-prestige').textContent = `Ã—${s.prestigeMultiplier}`;
    $('hud-pps').textContent    = pps.toLocaleString();
    // Sound button
    const sb = $('sound-btn');
    if (sb) sb.textContent = s.soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
  };

  /* â”€â”€ Color utility: lighten (positive amt) or darken (negative amt) a hex color â”€â”€ */
  const lightenHex = (hex, amt) => {
    if (!hex || !/^#[0-9a-fA-F]{6}$/.test(hex)) return hex || '#000000';
    const n = parseInt(hex.replace('#', ''), 16);
    const clamp = (v) => Math.max(0, Math.min(255, v));
    const r = clamp((n >> 16) + amt);
    const g = clamp(((n >> 8) & 0xff) + amt);
    const b = clamp((n & 0xff) + amt);
    return `#${((1 << 24) | (r << 16) | (g << 8) | b).toString(16).slice(1)}`;
  };

  /* â”€â”€ Mini jersey SVG for gallery / collection cards â”€â”€ */
  const miniJerseySVG = (fill, stroke, accent, label, size = 'md') => {
    const w = size === 'sm' ? 48 : 56, h = size === 'sm' ? 56 : 64;
    const fs = size === 'sm' ? 16 : 20;
    return `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 44 52" width="${w}" height="${h}" class="mini-jersey-wrap" role="img" aria-label="Jersey ${label}">
      <path d="M4 12 L0 22 L7 23.5 L7 48 L37 48 L37 23.5 L44 22 L40 12 L31 8 C29 16 15 16 13 8 Z"
            fill="${fill}" stroke="${stroke}" stroke-width="1.5"/>
      <path d="M7 23.5 L12 23.5 L12 48 L7 48 Z" fill="${accent}" opacity="0.85"/>
      <path d="M32 23.5 L37 23.5 L37 48 L32 48 Z" fill="${accent}" opacity="0.85"/>
      <rect x="0" y="20" width="7" height="3" fill="${accent}"/>
      <rect x="37" y="20" width="7" height="3" fill="${accent}"/>
      <rect x="0" y="16" width="7" height="2" fill="${accent}" opacity="0.5"/>
      <rect x="37" y="16" width="7" height="2" fill="${accent}" opacity="0.5"/>
      <path d="M17 8 Q22 13.5 27 8" fill="none" stroke="${stroke}" stroke-width="1.5" stroke-linecap="round"/>
      <text x="22" y="36" text-anchor="middle" font-family="'Bebas Neue',monospace" font-size="${fs}"
            fill="${accent}" stroke="${fill}" stroke-width="1" paint-order="stroke">${label}</text>
    </svg>`;
  };

  /* â”€â”€ Jersey â”€â”€ */
  const updateJersey = () => {
    const s = State.get();
    const legend = s.activeId ? LEGENDS.find(l => l.id === s.activeId) : null;

    const primary = legend ? legend.jerseyFill   : (s.jerseyCustomPrimary || '#002E5D');
    const stroke  = legend ? legend.jerseyStroke  : '#FFFFFF';
    const accent  = legend ? legend.accentColor   : (s.jerseyCustomAccent  || '#FFD700');

    // Gradient stops
    const gradLight = $('jersey-grad-light');
    const gradDark  = $('jersey-grad-dark');
    if (gradLight) gradLight.setAttribute('stop-color', lightenHex(primary, 22));
    if (gradDark)  gradDark.setAttribute('stop-color',  primary);

    // Main body stroke
    const mainPath = $('jersey-main');
    if (mainPath) mainPath.setAttribute('stroke', stroke);

    // Accent-colored elements (stripes, sleeves, name strip)
    ['jersey-stripe-l','jersey-stripe-r',
     'jersey-sleeve-l','jersey-sleeve-r',
     'jersey-sleeve2-l','jersey-sleeve2-r',
     'jersey-namestrip'].forEach(id => {
      const el = $(id);
      if (el) el.setAttribute('fill', accent);
    });

    // Collar
    const collar = $('jersey-collar');
    if (collar) collar.setAttribute('stroke', stroke);
    const collarFill = $('jersey-collar-fill');
    if (collarFill) collarFill.setAttribute('fill', lightenHex(primary, -10));

    // Number
    const numEl = $('jersey-number');
    numEl.textContent = legend ? legend.number : '?';
    numEl.setAttribute('fill', accent);
    numEl.setAttribute('stroke', primary);

    // Player name
    const nameEl = $('jersey-name-text');
    if (nameEl) {
      nameEl.textContent = legend ? legend.name.toUpperCase() : '';
      nameEl.setAttribute('fill', accent);
    }

    if (legend) {
      $('active-name').textContent  = legend.name;
      $('active-title').textContent = legend.title;
      $('active-legend-info').classList.remove('hidden');
      $('jersey-svg').classList.add('has-legend');
      const ppc = currentPPC();
      $('jersey-btn').setAttribute('aria-label',
        `Click to earn +${ppc} Cougar Point${ppc !== 1 ? 's' : ''} â€” ${legend.name} active`);
    } else {
      $('active-legend-info').classList.add('hidden');
      $('jersey-svg').classList.remove('has-legend');
      $('jersey-btn').setAttribute('aria-label', 'Click to earn Cougar Points');
    }
  };

  /* â”€â”€ Gallery (sidebar + panel) â”€â”€ */
  const TIER_LABELS = { bronze:'ğŸ¥‰', silver:'ğŸ¥ˆ', gold:'ğŸ¥‡', platinum:'ğŸ’', diamond:'ğŸ’ ', legendary:'ğŸŒŸ' };

  const renderCard = (legend, compact = false) => {
    const s = State.get();
    const unlocked = s.unlockedIds.includes(legend.id);
    const canAfford = s.points >= legend.cost;
    const isActive  = s.activeId === legend.id;
    const tierClass = legend.tier ? `tier-${legend.tier}` : '';
    const tierIcon  = legend.tier ? (TIER_LABELS[legend.tier] || '') : '';

    if (compact) {
      // Sidebar compact card
      return `
        <div class="legend-card rounded-lg border ${unlocked ? `border-byu-blue ${tierClass}` : 'border-white/10 bg-black/30 opacity-50'}
             bg-byu-navy/60 p-3 mb-3 flex items-center gap-3">
          <div class="flex-shrink-0">
            ${miniJerseySVG(legend.jerseyFill, legend.jerseyStroke, legend.accentColor, unlocked ? legend.number : '?', 'sm')}
          </div>
          <div class="flex-1 min-w-0">
            <div class="font-varsity text-sm leading-tight ${unlocked ? 'text-white' : 'text-white/40'} truncate">
              ${unlocked ? `${tierIcon} ${legend.name}` : '???'}
            </div>
            <div class="text-xs ${unlocked ? 'text-yellow-300' : 'text-white/30'}">${unlocked ? legend.title : `ğŸ”’ ${legend.cost.toLocaleString()} pts`}</div>
            ${unlocked ? `<div class="text-xs text-white/50">+${legend.ppc} PPC${legend.pps ? ` Â· +${legend.pps}/s` : ''}</div>` : ''}
          </div>
          ${unlocked && isActive ? '<span class="text-yellow-300 text-xs font-bold">â–¶ ACTIVE</span>' : ''}
        </div>`;
    }

    // Full panel card
    const prog = unlocked ? 100 : Math.min(100, Math.floor((s.points / legend.cost) * 100));
    return `
      <div class="legend-card rounded-xl border ${unlocked ? `border-byu-blue ${tierClass}` : 'border-white/10'} bg-byu-navy/70 p-4 mb-4 shadow-lg">
        <div class="flex items-center gap-3 mb-2">
          <div class="flex-shrink-0">
            ${miniJerseySVG(legend.jerseyFill, legend.jerseyStroke, legend.accentColor, unlocked ? legend.number : '?')}
          </div>
          <div>
            <div class="font-varsity text-lg ${unlocked ? 'text-white' : 'text-white/40'}">${unlocked ? `${tierIcon} ${legend.name}` : '???'}</div>
            <div class="text-xs italic ${unlocked ? 'text-yellow-300' : 'text-white/30'}">${unlocked ? legend.title : 'Locked'}</div>
            <div class="text-xs text-white/50 mt-1">Cost: <span class="text-yellow-200">${legend.cost.toLocaleString()} pts</span></div>
          </div>
        </div>
        <!-- Progress bar -->
        ${!unlocked ? `
        <div class="h-2 bg-white/10 rounded-full overflow-hidden mb-2">
          <div class="prog-bar-inner h-full rounded-full" style="width:${prog}%"></div>
        </div>
        <div class="text-right text-xs text-white/40 mb-2">${prog}%</div>` : ''}
        <!-- Unlock / Activate button -->
        <button
          onclick="Game.unlockOrActivate('${legend.id}')"
          class="w-full py-2 rounded font-varsity text-sm tracking-wide transition
                 ${unlocked
                   ? isActive
                     ? 'bg-yellow-400 text-byu-navy cursor-default'
                     : 'bg-byu-blue hover:bg-blue-400 text-white'
                   : canAfford
                     ? 'bg-green-600 hover:bg-green-500 text-white'
                     : 'bg-white/10 text-white/30 cursor-not-allowed'}"
          ${!unlocked && !canAfford ? 'disabled' : ''}
        >
          ${unlocked ? (isActive ? 'â–¶ ACTIVE' : 'ACTIVATE') : `UNLOCK â€” ${legend.cost.toLocaleString()} PTS`}
        </button>
        ${unlocked && legend.pps ? `<div class="text-xs text-cyan-300 text-center mt-1">+${legend.ppc} PPC Â· +${legend.pps} pts/sec</div>` : unlocked ? `<div class="text-xs text-white/40 text-center mt-1">+${legend.ppc} Points Per Click</div>` : ''}
      </div>`;
  };

  const renderGallery = () => {
    const gallery    = $('panel-gallery');
    const sidebar    = $('sidebar-gallery');
    const collection = $('panel-collection');

    // Gallery panel (unlock / activate)
    gallery.innerHTML = LEGENDS.map(l => renderCard(l, false)).join('');

    // Sidebar compact view
    sidebar.innerHTML = LEGENDS.map(l => renderCard(l, true)).join('');

    // Collection panel
    const s = State.get();
    if (s.unlockedIds.length === 0) {
      collection.innerHTML = `<p class="text-white/40 italic text-sm text-center py-6">Unlock legends to view their stats here.</p>`;
    } else {
      collection.innerHTML = s.unlockedIds.map(id => {
        const l = LEGENDS.find(lg => lg.id === id);
        return `
          <div class="rounded-xl border border-byu-blue bg-byu-navy/70 p-4 mb-4 shadow-lg">
            <div class="flex items-center gap-3 mb-3">
              <div class="flex-shrink-0">
                ${miniJerseySVG(l.jerseyFill, l.jerseyStroke, l.accentColor, l.number)}
              </div>
              <div>
                <div class="font-varsity text-lg text-white">${l.name}</div>
                <div class="text-xs italic text-yellow-300">${l.title}</div>
              </div>
            </div>
            <p class="text-white/70 text-xs mb-3 leading-relaxed">${l.description}</p>
            <div class="grid grid-cols-2 gap-2 text-center">
              <div class="bg-white/10 rounded p-2">
                <div class="font-varsity text-xl text-yellow-300">${l.stat1}</div>
                <div class="text-xs text-white/60">${l.stat1Label}</div>
              </div>
              <div class="bg-white/10 rounded p-2">
                <div class="font-varsity text-xl text-yellow-300">${l.stat2}</div>
                <div class="text-xs text-white/60">${l.stat2Label}</div>
              </div>
            </div>
            <div class="mt-2 text-center text-xs text-white/50">+${l.ppc} Points Per Click</div>
          </div>`;
      }).join('');
    }
  };

  /* â”€â”€ Stats panel â”€â”€ */
  const renderStats = () => {
    const s = State.get();
    const pps = currentPPS();
    $('panel-stats').innerHTML = `
      <div class="rounded-xl border border-byu-blue bg-byu-navy/70 p-4 shadow-lg space-y-3">
        <h3 class="font-varsity text-xl tracking-wide border-b border-white/20 pb-2">GAME STATS</h3>
        <div class="grid grid-cols-2 gap-2 text-center text-sm">
          <div class="bg-white/10 rounded p-2">
            <div class="font-varsity text-2xl text-yellow-300">${Math.floor(s.points).toLocaleString()}</div>
            <div class="text-xs text-white/60">Current Points</div>
          </div>
          <div class="bg-white/10 rounded p-2">
            <div class="font-varsity text-2xl text-yellow-300">${Math.floor(s.totalPoints).toLocaleString()}</div>
            <div class="text-xs text-white/60">All-Time Points</div>
          </div>
          <div class="bg-white/10 rounded p-2">
            <div class="font-varsity text-2xl text-yellow-300">${s.clickCount.toLocaleString()}</div>
            <div class="text-xs text-white/60">Total Clicks</div>
          </div>
          <div class="bg-white/10 rounded p-2">
            <div class="font-varsity text-2xl text-yellow-300">${s.unlockedIds.length} / ${LEGENDS.length}</div>
            <div class="text-xs text-white/60">Legends Unlocked</div>
          </div>
          <div class="bg-white/10 rounded p-2">
            <div class="font-varsity text-2xl text-yellow-300">${s.prestigeLevel}</div>
            <div class="text-xs text-white/60">Prestiges</div>
          </div>
          <div class="bg-white/10 rounded p-2">
            <div class="font-varsity text-2xl text-yellow-300">Ã—${s.prestigeMultiplier}</div>
            <div class="text-xs text-white/60">Point Multiplier</div>
          </div>
          <div class="bg-white/10 rounded p-2">
            <div class="font-varsity text-2xl text-cyan-300">${pps.toLocaleString()}</div>
            <div class="text-xs text-white/60">Points / Sec</div>
          </div>
          <div class="bg-white/10 rounded p-2">
            <div class="font-varsity text-2xl text-cyan-300">${(s.purchasedUpgrades||[]).length} / ${UPGRADES.length}</div>
            <div class="text-xs text-white/60">Upgrades Owned</div>
          </div>
        </div>
        ${s.prestigeLevel > 0 ? `<p class="text-yellow-300 text-xs text-center italic">ğŸ† ${s.prestigeLevel}Ã— Prestige Legend!</p>` : ''}
        <h4 class="font-varsity text-lg border-b border-white/20 pb-1 mt-4">ACHIEVEMENTS</h4>
        <div class="grid grid-cols-1 gap-1 mt-2">
          ${ACHIEVEMENTS.map(a => {
            const owned = (s.earnedAchievements||[]).includes(a.id);
            return `<div class="flex items-center gap-2 ${owned ? '' : 'opacity-40'} bg-white/5 rounded p-2">
              <span class="text-lg leading-none">${a.icon}</span>
              <div class="flex-1 min-w-0">
                <div class="font-varsity text-sm ${owned ? 'text-yellow-300' : 'text-white/60'}">${a.name}</div>
                <div class="text-xs text-white/40 leading-tight">${a.desc}</div>
              </div>
              ${a.reward ? `<div class="text-xs text-yellow-300 whitespace-nowrap">+${a.reward.toLocaleString()}</div>` : ''}
              <span class="${owned ? 'text-green-400' : 'text-white/20'} text-sm">${owned ? 'âœ“' : 'â—‹'}</span>
            </div>`;
          }).join('')}
        </div>
        <p class="text-white/30 text-xs text-center italic mt-2">${(s.earnedAchievements||[]).length}/${ACHIEVEMENTS.length} achievements earned</p>
      </div>`;
  };

  /* â”€â”€ Next unlock progress â”€â”€ */
  const updateNextUnlock = () => {
    const s   = State.get();
    const next = LEGENDS.find(l => !s.unlockedIds.includes(l.id));
    const wrap = $('next-unlock-wrap');
    if (!next) {
      wrap.classList.add('hidden');
      return;
    }
    wrap.classList.remove('hidden');
    const pct = Math.min(100, Math.floor((s.points / next.cost) * 100));
    $('next-unlock-label').textContent = `Next: ${next.name}`;
    $('next-unlock-pct').textContent   = `${pct}%`;
    $('next-unlock-bar').style.width   = `${pct}%`;
  };

  /* â”€â”€ Prestige button â”€â”€ */
  const updatePrestigeBtn = () => {
    const s = State.get();
    const allUnlocked = LEGENDS.every(l => s.unlockedIds.includes(l.id));
    const atMaxPrestige = s.prestigeLevel >= MAX_PRESTIGE_LEVEL;
    $('prestige-btn').classList.toggle('hidden', !allUnlocked || atMaxPrestige);
  };

  /* â”€â”€ Tab switching â”€â”€ */
  const showTab = (tab) => {
    ['gallery', 'upgrades', 'collection', 'stats', 'customize', 'minigames', 'leaderboard'].forEach(t => {
      document.getElementById(`panel-${t}`).classList.toggle('hidden', t !== tab);
      document.getElementById(`tab-${t}`).classList.toggle('active', t === tab);
    });
    if (tab === 'stats')       renderStats();
    if (tab === 'upgrades')    renderUpgrades();
    if (tab === 'customize')   renderCustomize();
    if (tab === 'minigames')   MiniGames.render();
    if (tab === 'leaderboard') Leaderboard.render();
  };

  /* â”€â”€ Jersey Customizer panel â”€â”€ */
  const renderCustomize = () => {
    const s = State.get();
    const panel = $('panel-customize');
    if (!panel) return;

    const primaryColors = [
      { hex: '#002E5D', label: 'BYU Navy' },
      { hex: '#001020', label: 'Midnight' },
      { hex: '#001a3a', label: 'Dark Navy' },
      { hex: '#003300', label: 'Forest' },
      { hex: '#4A0010', label: 'Cardinal' },
      { hex: '#2D0060', label: 'Purple' },
      { hex: '#0A0A0A', label: 'Blackout' },
      { hex: '#1a1a2e', label: 'Indigo' },
      { hex: '#003333', label: 'Teal' },
    ];
    const accentColors = [
      { hex: '#FFD700', label: 'Gold' },
      { hex: '#FFFFFF', label: 'White' },
      { hex: '#0062B8', label: 'Royal' },
      { hex: '#00e5ff', label: 'Cyan' },
      { hex: '#FF4500', label: 'Orange' },
      { hex: '#C0C0C0', label: 'Silver' },
      { hex: '#00C853', label: 'Green' },
      { hex: '#FF1744', label: 'Red' },
      { hex: '#E040FB', label: 'Violet' },
    ];

    const curPrimary = s.jerseyCustomPrimary || '#002E5D';
    const curAccent  = s.jerseyCustomAccent  || '#FFD700';

    const swatchRow = (colors, type, current) =>
      colors.map(c => `
        <button class="color-swatch${current === c.hex ? ' swatch-selected' : ''}"
                style="background:${c.hex}"
                title="${c.label}"
                aria-label="Select ${c.label} as jersey ${type} color"
                onclick="Game.setJerseyColor('${type}','${c.hex}')"></button>
      `).join('');

    panel.innerHTML = `
      <div class="rounded-xl border border-byu-blue bg-byu-navy/70 p-4 shadow-lg space-y-4">
        <h3 class="font-varsity text-xl tracking-wide border-b border-white/20 pb-2">ğŸ¨ JERSEY CUSTOMIZER</h3>
        <p class="text-white/50 text-xs italic">Customize the default jersey. Active legends show their official colors.</p>
        <div class="flex justify-center mb-2">
          ${miniJerseySVG(curPrimary, '#FFFFFF', curAccent, '?')}
        </div>
        <div>
          <div class="font-varsity text-sm text-white/80 mb-2 tracking-wide">PRIMARY COLOR</div>
          <div class="flex flex-wrap gap-2">${swatchRow(primaryColors, 'primary', curPrimary)}</div>
        </div>
        <div>
          <div class="font-varsity text-sm text-white/80 mb-2 tracking-wide">ACCENT / STRIPE COLOR</div>
          <div class="flex flex-wrap gap-2">${swatchRow(accentColors, 'accent', curAccent)}</div>
        </div>
        <button onclick="Game.setJerseyColor('reset','')"
                class="w-full py-2 rounded font-varsity text-sm tracking-wide bg-white/10 hover:bg-white/20 text-white/60 transition">
          â†º RESET TO BYU DEFAULTS
        </button>
        <p class="text-white/30 text-xs text-center italic">Colors are saved automatically</p>
      </div>`;
  };

  /* â”€â”€ Upgrades panel â”€â”€ */
  const renderUpgrades = () => {
    const s = State.get();
    const panel = $('panel-upgrades');
    panel.innerHTML = `
      <p class="text-white/50 text-xs italic mb-3 text-center">Auto-clickers earn points every second, even while idle!</p>
      ${UPGRADES.map(u => {
        const owned   = (s.purchasedUpgrades || []).includes(u.id);
        const canBuy  = !owned && s.points >= u.cost;
        return `
          <div class="upgrade-card rounded-xl border ${owned ? 'border-cyan-400 bg-cyan-900/20' : 'border-white/10 bg-byu-navy/70'} p-4 mb-3 shadow-lg">
            <div class="flex items-center justify-between gap-2">
              <div>
                <div class="font-varsity text-lg ${owned ? 'text-cyan-300' : 'text-white'}">${owned ? 'âœ… ' : ''}${u.name}</div>
                <div class="text-xs text-white/60">${u.desc}</div>
                ${owned ? '' : `<div class="text-xs text-yellow-200 mt-1">Cost: ${u.cost.toLocaleString()} pts</div>`}
              </div>
              <button onclick="Game.buyUpgrade('${u.id}')"
                class="font-varsity text-sm px-4 py-2 rounded transition
                       ${owned ? 'bg-white/10 text-white/30 cursor-default' : canBuy ? 'bg-cyan-600 hover:bg-cyan-500 text-white' : 'bg-white/10 text-white/30 cursor-not-allowed'}"
                ${owned || !canBuy ? 'disabled' : ''}>
                ${owned ? 'OWNED' : 'BUY'}
              </button>
            </div>
          </div>`;
      }).join('')}`;
  };

  /* â”€â”€ Float-up label â”€â”€ */
  const spawnFloat = (x, y, text) => {
    const el = document.createElement('div');
    el.className = 'float-label';
    el.textContent = text;
    el.style.left  = `${x - 16}px`;
    el.style.top   = `${y - 20}px`;
    document.body.appendChild(el);
    el.addEventListener('animationend', () => el.remove());
  };

  /* â”€â”€ Full refresh â”€â”€ */
  const refresh = () => {
    updateHUD();
    updateJersey();
    renderGallery();
    updateNextUnlock();
    updatePrestigeBtn();
  };

  return { refresh, updateHUD, updateNextUnlock, updatePrestigeBtn, renderStats, renderUpgrades, renderCustomize, showTab, spawnFloat };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HELPERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function currentPPC() {
  const s = State.get();
  const legend = s.activeId ? LEGENDS.find(l => l.id === s.activeId) : null;
  const base = legend ? legend.ppc : 1;
  return base * s.prestigeMultiplier;
}

function currentPPS() {
  const s = State.get();
  const legendPps = s.unlockedIds.reduce((sum, id) => {
    const l = LEGENDS.find(lg => lg.id === id);
    return sum + (l ? (l.pps || 0) : 0);
  }, 0);
  const upgradePps = (s.purchasedUpgrades || []).reduce((sum, uid) => {
    const u = UPGRADES.find(u => u.id === uid);
    return sum + (u ? u.pps : 0);
  }, 0);
  return (legendPps + upgradePps) * s.prestigeMultiplier;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME CONTROLLER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Game = (() => {

  const handleClick = (event) => {
    const s   = State.get();
    const ppc = currentPPC();
    const comboMult = Combo.register();
    const earned = Math.ceil(ppc * comboMult);

    State.update({
      points:      s.points + earned,
      totalPoints: s.totalPoints + earned,
      clickCount:  s.clickCount + 1,
    });

    Sound.click();

    // Get click coordinates for the float label
    let cx, cy;
    if (event.touches && event.touches.length) {
      cx = event.touches[0].clientX;
      cy = event.touches[0].clientY;
    } else if (typeof event.clientX === 'number' && event.clientX !== 0) {
      cx = event.clientX;
      cy = event.clientY;
    } else {
      // Keyboard activation â€” center float on the jersey button
      const rect = document.getElementById('jersey-btn').getBoundingClientRect();
      cx = rect.left + rect.width / 2;
      cy = rect.top + rect.height / 2;
    }
    const label = comboMult > 1 ? `+${earned} Ã—${comboMult.toFixed(2)}` : `+${earned}`;
    UI.spawnFloat(cx, cy, label);
    Particles.spawn(cx, cy, comboMult >= 1.5 ? 12 : 7);

    UI.updateHUD();
    UI.updateNextUnlock();
    checkAchievements();

    // Auto-check unlocks
    LEGENDS.forEach(l => {
      if (!State.get().unlockedIds.includes(l.id) && State.get().points >= l.cost) {
        _tryAutoUnlock(l);
      }
    });
  };

  const _tryAutoUnlock = (legend) => {
    // Points are milestones â€” they are never deducted. Reaching the threshold triggers the unlock.
    const s = State.get();
    if (s.unlockedIds.includes(legend.id)) return;
    const newUnlocked = [...s.unlockedIds, legend.id];
    State.update({ unlockedIds: newUnlocked });
    _showUnlockToast(legend);
    Sound.unlock();
    Particles.flash();
    // Auto-activate the highest-tier unlocked legend
    State.update({ activeId: legend.id });
    UI.refresh();
    checkAchievements();
  };

  const _showUnlockToast = (legend) => {
    const toast = document.createElement('div');
    toast.className = `
      fixed bottom-6 left-1/2 -translate-x-1/2 z-50
      bg-byu-blue border-2 border-yellow-300 text-white
      font-varsity text-lg px-6 py-3 rounded-xl shadow-2xl
      flex items-center gap-2
    `;
    toast.innerHTML = `ğŸˆ LEGEND UNLOCKED: <span class="text-yellow-300">${legend.name}</span> â€” ${legend.title}`;
    document.body.appendChild(toast);
    setTimeout(() => {
      toast.style.transition = 'opacity .5s';
      toast.style.opacity = '0';
      setTimeout(() => toast.remove(), 600);
    }, 3000);
  };

  const unlockOrActivate = (id) => {
    const s = State.get();
    if (s.unlockedIds.includes(id)) {
      // Just activate
      State.update({ activeId: id });
      UI.refresh();
      return;
    }
    const legend = LEGENDS.find(l => l.id === id);
    if (s.points < legend.cost) return; // not enough
    const newUnlocked = [...s.unlockedIds, legend.id];
    State.update({
      unlockedIds: newUnlocked,
      activeId: id,
    });
    _showUnlockToast(legend);
    Sound.unlock();
    Particles.flash();
    UI.refresh();
    checkAchievements();
  };

  const buyUpgrade = (uid) => {
    const s = State.get();
    const u = UPGRADES.find(u => u.id === uid);
    if (!u || (s.purchasedUpgrades || []).includes(uid)) return;
    if (s.points < u.cost) return;
    State.update({
      points: s.points - u.cost,
      purchasedUpgrades: [...(s.purchasedUpgrades || []), uid],
    });
    Sound.unlock();
    UI.refresh();
    UI.renderUpgrades();
    checkAchievements();
  };

  const prestige = () => {
    const s = State.get();
    const allUnlocked = LEGENDS.every(l => s.unlockedIds.includes(l.id));
    if (!allUnlocked) return;
    if (s.prestigeLevel >= MAX_PRESTIGE_LEVEL) return;

    const confirmed = window.confirm(
      `â­ PRESTIGE â­\n\nYou will reset all progress, but your Cougar Points multiplier will double to Ã—${s.prestigeMultiplier * 2}!\n\nAre you ready to become a Cougar Legend?`
    );
    if (!confirmed) return;

    const newLevel = s.prestigeLevel + 1;
    const newMult  = Math.pow(2, newLevel); // 2^n
    State.update({
      points:             0,
      unlockedIds:        [],
      activeId:           null,
      prestigeLevel:      newLevel,
      prestigeMultiplier: newMult,
      purchasedUpgrades:  [],
    });
    Sound.prestige();
    UI.refresh();
    checkAchievements();

    // Celebrate
    const toast = document.createElement('div');
    toast.className = `
      fixed inset-0 flex items-center justify-center z-50 bg-black/70
    `;
    toast.innerHTML = `
      <div class="bg-byu-navy border-4 border-yellow-300 rounded-2xl p-8 text-center max-w-sm mx-4">
        <div class="font-varsity text-5xl text-yellow-300 mb-2">â­ PRESTIGE ${newLevel} â­</div>
        <div class="text-white text-lg mb-4">You are now a <span class="text-yellow-300 font-bold">Ã—${newMult}</span> Cougar Legend!</div>
        <button onclick="this.closest('.fixed').remove()" class="bg-yellow-400 text-byu-navy font-varsity text-xl px-8 py-3 rounded-lg hover:bg-yellow-300 transition">LET'S GO COUGARS!</button>
      </div>`;
    document.body.appendChild(toast);
  };

  const showTab = (tab) => UI.showTab(tab);

  const setJerseyColor = (type, color) => {
    if (type === 'reset') {
      State.update({ jerseyCustomPrimary: '#002E5D', jerseyCustomAccent: '#FFD700' });
    } else if (type === 'primary') {
      State.update({ jerseyCustomPrimary: color });
    } else if (type === 'accent') {
      State.update({ jerseyCustomAccent: color });
    }
    UI.refresh();
    UI.renderCustomize();
  };

  const checkAchievements = () => {
    const s = State.get();
    const earned = s.earnedAchievements || [];
    const newlyEarned = ACHIEVEMENTS.filter(a => !earned.includes(a.id) && a.check(s));
    if (newlyEarned.length === 0) return;
    const newIds = [...earned, ...newlyEarned.map(a => a.id)];
    const reward = newlyEarned.reduce((t, a) => t + a.reward, 0);
    const s2 = State.get();
    State.update({ earnedAchievements: newIds, points: s2.points + reward, totalPoints: s2.totalPoints + reward });
    if (reward > 0) UI.updateHUD();
    newlyEarned.forEach((a, i) => setTimeout(() => {
      const t = document.createElement('div');
      t.className = 'fixed bottom-6 right-4 z-50 bg-yellow-900/95 border-2 border-yellow-400 text-white font-varsity text-sm px-4 py-3 rounded-xl shadow-2xl flex items-center gap-2';
      t.innerHTML = `${a.icon} ACHIEVEMENT: <span class="text-yellow-300 ml-1">${a.name}</span>${a.reward ? `<span class="text-green-300 ml-2">+${a.reward.toLocaleString()}</span>` : ''}`;
      document.body.appendChild(t);
      setTimeout(() => { t.style.transition = 'opacity .5s'; t.style.opacity = '0'; setTimeout(() => t.remove(), 600); }, 3500);
    }, i * 700));
  };

  const _checkDailyBonus = () => {
    const today = new Date().toISOString().slice(0, 10);
    const s = State.get();
    if (s.lastLoginDate === today) return;
    const streak = (s.dailyBonusClaimed || 0) + 1;
    const bonus = Math.floor(DAILY_BONUS_BASE * (s.prestigeMultiplier || 1) * Math.min(streak, 10));
    State.update({ lastLoginDate: today, dailyBonusClaimed: streak, points: s.points + bonus, totalPoints: s.totalPoints + bonus });
    UI.updateHUD();
    const t = document.createElement('div');
    t.className = 'fixed top-20 left-1/2 -translate-x-1/2 z-50 bg-green-800 border-2 border-yellow-300 text-white font-varsity text-lg px-6 py-4 rounded-xl shadow-2xl text-center';
    t.innerHTML = `ğŸ“… DAILY BONUS<br><span class="text-yellow-300 text-2xl">+${bonus.toLocaleString()} pts</span><br><span class="text-xs text-white/70">Day ${streak} streak!</span>`;
    document.body.appendChild(t);
    setTimeout(() => { t.style.transition = 'opacity .5s'; t.style.opacity = '0'; setTimeout(() => t.remove(), 600); }, 4500);
    checkAchievements();
  };

  const init = () => {
    State.load();
    UI.refresh();
    _checkDailyBonus();
    checkAchievements();

    // Global keyboard shortcut: Space anywhere to click jersey
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && !e.repeat && !['INPUT', 'TEXTAREA', 'BUTTON', 'SELECT', 'A'].includes(e.target.tagName)) {
        e.preventDefault();
        handleClick({ clientX: 0, clientY: 0 });
      }
    });

    // Touch support for jersey
    document.getElementById('jersey-btn').addEventListener('touchstart', (e) => {
      e.preventDefault();
      Game.handleClick(e);
    }, { passive: false });

    // Passive income tick (every second)
    setInterval(() => {
      const pps = currentPPS();
      if (pps <= 0) return;
      const s = State.get();
      State.update({
        points:      s.points + pps,
        totalPoints: s.totalPoints + pps,
      });
      UI.updateHUD();
      UI.updateNextUnlock();
      // Floating auto-tick indicator (subtle, near jersey)
      const jerseyEl = document.getElementById('jersey-btn');
      if (jerseyEl) {
        const rect = jerseyEl.getBoundingClientRect();
        const el = document.createElement('div');
        el.className = 'auto-tick';
        el.textContent = `+${pps}/s`;
        el.style.left = `${rect.left + rect.width / 2 + (Math.random() - 0.5) * 60}px`;
        el.style.top  = `${rect.top + 20}px`;
        document.body.appendChild(el);
        el.addEventListener('animationend', () => el.remove());
      }
      // Auto-check unlocks
      const sAfter = State.get();
      LEGENDS.forEach(l => {
        if (!sAfter.unlockedIds.includes(l.id) && sAfter.points >= l.cost) {
          _tryAutoUnlock(l);
        }
      });
    }, 1000);
  };

  return { handleClick, unlockOrActivate, buyUpgrade, prestige, showTab, setJerseyColor, checkAchievements, init };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LEADERBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const Leaderboard = (() => {
  const KEY = 'byu_leaderboard';

  // Simulated global top players (static seeds to make leaderboard feel alive)
  const GLOBAL_SEEDS = [
    { name: 'CougarFan2024 ğŸŒ',  score: 52000000 },
    { name: 'BYULegend ğŸŒ',      score: 37000000 },
    { name: 'ZachWilsonFan ğŸŒ',  score: 29000000 },
    { name: 'LaVellEdwards1 ğŸŒ', score: 23000000 },
    { name: 'RiseAndShout ğŸŒ',   score: 18500000 },
    { name: 'JimmerForever ğŸŒ',  score: 14000000 },
    { name: 'BoscoNation ğŸŒ',    score: 11000000 },
    { name: 'TyDetmerFan ğŸŒ',    score: 8500000  },
    { name: 'CougarBlue ğŸŒ',     score: 6000000  },
    { name: 'HailMaryMike ğŸŒ',   score: 4000000  },
  ];

  const _getLocal = () => {
    try { return JSON.parse(localStorage.getItem(KEY) || '[]'); } catch { return []; }
  };

  const _saveLocal = (entries) => {
    try { localStorage.setItem(KEY, JSON.stringify(entries)); } catch {}
  };

  const getAll = () => {
    const local = _getLocal().map(e => ({ ...e, isLocal: true }));
    const merged = [...GLOBAL_SEEDS.map(e => ({ ...e, isLocal: false })), ...local];
    merged.sort((a, b) => b.score - a.score);
    return merged.slice(0, 25);
  };

  const submitScore = () => {
    const input = document.getElementById('lb-name-input');
    const rawName = (input ? input.value.trim() : '') || 'Anonymous Cougar';
    const name = rawName.slice(0, 20);
    const score = Math.floor(State.get().totalPoints);
    const entries = _getLocal();
    entries.push({ name, score, date: new Date().toLocaleDateString() });
    entries.sort((a, b) => b.score - a.score);
    entries.splice(20);
    _saveLocal(entries);
    const s = State.get();
    State.update({ leaderboardSubmits: (s.leaderboardSubmits || 0) + 1 });
    Sound.unlock();
    Game.checkAchievements();
    render();
  };

  const render = () => {
    const panel = document.getElementById('panel-leaderboard');
    if (!panel) return;
    const s = State.get();
    const myScore = Math.floor(s.totalPoints);
    const entries = getAll();
    const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];

    panel.innerHTML = `
      <div class="rounded-xl border border-yellow-400/50 bg-byu-navy/70 p-4 shadow-lg space-y-3">
        <h3 class="font-varsity text-xl tracking-wide border-b border-white/20 pb-2">ğŸ† GLOBAL LEADERBOARD</h3>
        <p class="text-white/50 text-xs italic text-center">Your all-time points: <span class="text-yellow-300 font-bold">${myScore.toLocaleString()}</span></p>

        <!-- Submit Score -->
        <div class="flex gap-2">
          <input id="lb-name-input" type="text" maxlength="20" placeholder="Your name (max 20 chars)"
            class="flex-1 bg-white/10 border border-white/20 rounded px-3 py-2 text-white text-sm placeholder-white/30 focus:outline-none focus:border-yellow-400"/>
          <button onclick="Leaderboard.submitScore()"
            class="font-varsity text-sm px-4 py-2 rounded bg-yellow-400 text-byu-navy hover:bg-yellow-300 transition whitespace-nowrap">
            SUBMIT
          </button>
        </div>

        <!-- Leaderboard rows -->
        <div class="space-y-1 mt-1">
          ${entries.map((e, i) => {
            const rank = medals[i] || `${i + 1}.`;
            const highlight = e.isLocal ? 'bg-byu-blue/30 border border-byu-blue/50' : 'bg-white/5';
            const dateTag = e.isLocal && e.date ? `<span class="text-white/30 text-xs ml-1">${e.date}</span>` : '';
            return `
              <div class="flex items-center gap-2 ${highlight} rounded px-2 py-1.5">
                <span class="font-varsity text-sm w-8 text-center flex-shrink-0">${rank}</span>
                <span class="flex-1 text-sm truncate ${e.isLocal ? 'text-yellow-200' : 'text-white/70'}">${e.name}${dateTag}</span>
                <span class="font-varsity text-yellow-300 text-sm whitespace-nowrap">${e.score.toLocaleString()}</span>
              </div>`;
          }).join('')}
        </div>
        <p class="text-white/30 text-xs text-center italic">ğŸŒ = global players Â· Submit to add your score!</p>
        <p class="text-white/20 text-xs text-center italic">${(s.leaderboardSubmits||0)} submission${(s.leaderboardSubmits||0)!==1?'s':''} made</p>
      </div>`;
  };

  return { render, submitScore, getAll };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MINI GAMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MiniGames = (() => {
  // Difficulty scaling constants
  const FG_BASE_SPEED   = 1.5,  FG_MAX_SPEED   = 3.5,  FG_SPEED_INC   = 0.15;
  const FT_BASE_SPEED   = 1.2,  FT_MAX_SPEED   = 3.2,  FT_SPEED_INC   = 0.12;
  // Scoring thresholds (distance from center 0â€“50; smaller = tighter sweet spot)
  const PERFECT_DIST = 8, GOOD_DIST = 22;
  // Bonus Cougar Points awarded per outcome
  const FG_BONUS_PERFECT = 150, FG_BONUS_GOOD = 30;
  const FT_BONUS_PERFECT = 100, FT_BONUS_GOOD = 25;

  const _st = {
    fg: { active: false, val: 0, dir: 1, speed: 1.5, animId: null, wins: 0, total: 0 },
    ft: { active: false, val: 0, dir: 1, speed: 1.2, animId: null, wins: 0, total: 0 },
    hm: { active: false, clicks: 0, timeLeft: 0, timerId: null, best: 0, total: 0 },
    td: { active: false, yards: 0, tds: 0, timeLeft: 0, timerId: null, bestTds: 0, total: 0 },
  };

  /* â”€â”€ Field Goal Kick â”€â”€ */
  const _fgTick = () => {
    const g = _st.fg;
    g.val += g.dir * g.speed;
    if (g.val >= 100) { g.val = 100; g.dir = -1; }
    if (g.val <= 0)   { g.val = 0;   g.dir =  1; }
    const el = document.getElementById('mg-fg-ind');
    if (el) el.style.left = `${g.val}%`;
    g.animId = requestAnimationFrame(_fgTick);
  };

  const kickFG = () => {
    const g = _st.fg;
    if (!g.active) {
      g.active = true; g.val = 0; g.dir = 1;
      g.speed = Math.min(FG_MAX_SPEED, FG_BASE_SPEED + g.total * FG_SPEED_INC);
      const s = State.get();
      State.update({ miniGamesPlayed: (s.miniGamesPlayed || 0) + 1 });
      Game.checkAchievements();
      const btn = document.getElementById('mg-fg-btn');
      if (btn) btn.textContent = 'âš¡ KICK!';
      const res = document.getElementById('mg-fg-res');
      if (res) res.textContent = '';
      _fgTick();
      return;
    }
    cancelAnimationFrame(g.animId);
    g.active = false;
    g.total++;
    const dist = Math.abs(g.val - 50);
    let msg, bonus;
    if (dist <= PERFECT_DIST) { msg = 'âœ… GOOD â€” 3 pts!'; bonus = FG_BONUS_PERFECT; g.wins++; Sound.unlock(); }
    else if (dist <= GOOD_DIST) { msg = 'âš ï¸ Wide â€” 1 pt';   bonus = FG_BONUS_GOOD;           Sound.click();  }
    else                        { msg = 'âŒ No Good!';        bonus = 0; }
    if (bonus > 0) {
      const s = State.get();
      State.update({ points: s.points + bonus, totalPoints: s.totalPoints + bonus });
      UI.updateHUD();
    }
    const res = document.getElementById('mg-fg-res');
    if (res) res.textContent = msg + (bonus ? ` +${bonus} Cougar Pts` : '');
    const score = document.getElementById('mg-fg-score');
    if (score) score.textContent = `${g.wins}/${g.total}`;
    const btn = document.getElementById('mg-fg-btn');
    if (btn) btn.textContent = 'â–¶ TRY Again';
  };

  /* â”€â”€ Free Throw â”€â”€ */
  const _ftTick = () => {
    const g = _st.ft;
    g.val += g.dir * g.speed;
    if (g.val >= 100) { g.val = 100; g.dir = -1; }
    if (g.val <= 0)   { g.val = 0;   g.dir =  1; }
    const el = document.getElementById('mg-ft-ind');
    if (el) el.style.left = `${g.val}%`;
    g.animId = requestAnimationFrame(_ftTick);
  };

  const shootFT = () => {
    const g = _st.ft;
    if (!g.active) {
      g.active = true; g.val = 0; g.dir = 1;
      g.speed = Math.min(FT_MAX_SPEED, FT_BASE_SPEED + g.total * FT_SPEED_INC);
      const s = State.get();
      State.update({ miniGamesPlayed: (s.miniGamesPlayed || 0) + 1 });
      Game.checkAchievements();
      const btn = document.getElementById('mg-ft-btn');
      if (btn) btn.textContent = 'ğŸ€ SHOOT!';
      const res = document.getElementById('mg-ft-res');
      if (res) res.textContent = '';
      _ftTick();
      return;
    }
    cancelAnimationFrame(g.animId);
    g.active = false;
    g.total++;
    const dist = Math.abs(g.val - 50);
    let msg, bonus;
    if (dist <= PERFECT_DIST) { msg = 'ğŸ¯ SWISH! +2 pts!';  bonus = FT_BONUS_PERFECT; g.wins++; Sound.unlock(); }
    else if (dist <= GOOD_DIST) { msg = 'ğŸ˜… Rolls in â€” 1 pt'; bonus = FT_BONUS_GOOD;           Sound.click();  }
    else                        { msg = 'âŒ Brick!';            bonus = 0; }
    if (bonus > 0) {
      const s = State.get();
      State.update({ points: s.points + bonus, totalPoints: s.totalPoints + bonus });
      UI.updateHUD();
    }
    const res = document.getElementById('mg-ft-res');
    if (res) res.textContent = msg + (bonus ? ` +${bonus} Cougar Pts` : '');
    const score = document.getElementById('mg-ft-score');
    if (score) score.textContent = `${g.wins}/${g.total}`;
    const btn = document.getElementById('mg-ft-btn');
    if (btn) btn.textContent = 'â–¶ Try Again';
  };

  /* â”€â”€ Two-Minute Drill â”€â”€ */
  const startTwoDrill = () => {
    const g = _st.td;
    if (g.active) {
      // Each click during game = 5-10 yards gained
      const gain = 5 + Math.floor(Math.random() * 6);
      g.yards += gain;
      const yardEl = document.getElementById('mg-td-yards');
      if (yardEl) yardEl.textContent = g.yards % 100;
      const gainEl = document.getElementById('mg-td-gain');
      if (gainEl) { gainEl.textContent = `+${gain} yds`; gainEl.style.opacity = '1'; setTimeout(() => { gainEl.style.opacity = '0'; }, 400); }
      // Touchdown scored!
      if (g.yards >= 100 * (g.tds + 1)) {
        g.tds++;
        const tdBonus = 750;
        const s = State.get();
        State.update({ points: s.points + tdBonus, totalPoints: s.totalPoints + tdBonus });
        UI.updateHUD();
        Sound.unlock();
        const tdEl = document.getElementById('mg-td-tds');
        if (tdEl) tdEl.textContent = g.tds;
        const resEl = document.getElementById('mg-td-res');
        if (resEl) resEl.textContent = `ğŸˆ TOUCHDOWN #${g.tds}! +${tdBonus} pts`;
      }
      return;
    }
    // Start game
    g.active = true;
    g.yards = 0;
    g.tds = 0;
    g.timeLeft = 20;
    g.total++;
    const sStart = State.get();
    State.update({ miniGamesPlayed: (sStart.miniGamesPlayed || 0) + 1 });
    Game.checkAchievements();
    const btn = document.getElementById('mg-td-btn');
    if (btn) btn.textContent = 'ğŸƒ RUN PLAY!';
    const resEl = document.getElementById('mg-td-res');
    if (resEl) resEl.textContent = '';
    const yardEl = document.getElementById('mg-td-yards');
    if (yardEl) yardEl.textContent = '0';
    const tdEl = document.getElementById('mg-td-tds');
    if (tdEl) tdEl.textContent = '0';
    clearInterval(g.timerId);
    g.timerId = setInterval(() => {
      g.timeLeft--;
      const timerEl = document.getElementById('mg-td-timer');
      if (timerEl) timerEl.textContent = g.timeLeft;
      if (g.timeLeft <= 0) {
        clearInterval(g.timerId);
        g.active = false;
        if (g.tds > g.bestTds) g.bestTds = g.tds;
        // Incomplete yards toward the next touchdown earn bonus points at a 5:1 ratio (5 pts per yard)
        const extraYardsBonus = Math.floor((g.yards % 100) * 5);
        const msg = g.tds >= 3 ? 'ğŸŒŸ INCREDIBLE DRIVE!' : g.tds >= 2 ? 'ğŸ‰ Great game!' : g.tds >= 1 ? 'ğŸ‘ Nice TD!' : 'ğŸ˜… No score â€” keep practicing!';
        const resElEnd = document.getElementById('mg-td-res');
        if (resElEnd) resElEnd.textContent = `${msg} Total bonus: +${(g.tds * 750 + extraYardsBonus).toLocaleString()} pts`;
        if (g.tds >= 2) Sound.prestige(); else if (g.tds >= 1) Sound.unlock();
        if (extraYardsBonus > 0) {
          const sEnd = State.get();
          State.update({ points: sEnd.points + extraYardsBonus, totalPoints: sEnd.totalPoints + extraYardsBonus });
          UI.updateHUD();
        }
        const btn2 = document.getElementById('mg-td-btn');
        if (btn2) btn2.textContent = 'â–¶ Play Again';
        const bestEl = document.getElementById('mg-td-best');
        if (bestEl) bestEl.textContent = g.bestTds;
      }
    }, 1000);
  };

  const render = () => {
    const panel = document.getElementById('panel-minigames');
    if (!panel) return;
    const fg = _st.fg, ft = _st.ft, td = _st.td;
    const fgBtnText = fg.active ? 'âš¡ KICK!' : (fg.total > 0 ? 'â–¶ Try Again' : 'â–¶ START KICK');
    const ftBtnText = ft.active ? 'ğŸ€ SHOOT!' : (ft.total > 0 ? 'â–¶ Try Again' : 'â–¶ START SHOOTING');
    const tdBtnText = td.active ? 'ğŸƒ RUN PLAY!' : (td.total > 0 ? 'â–¶ Play Again' : 'â–¶ START DRILL');
    panel.innerHTML = `
      <div class="space-y-4">
        <p class="text-white/50 text-xs italic text-center">Play mini games to earn bonus Cougar Points!</p>

        <!-- Two-Minute Drill -->
        <div class="rounded-xl border border-green-400/50 bg-byu-navy/70 p-4 shadow-lg">
          <h3 class="font-varsity text-xl tracking-wide border-b border-white/20 pb-2 mb-3">ğŸˆ TWO-MINUTE DRILL</h3>
          <p class="text-xs text-white/50 text-center mb-3">Click rapidly for <strong class="text-white/70">20 seconds</strong> to gain yards! Each 100 yards = <span class="text-green-300">TOUCHDOWN +750 pts</span>!</p>
          <div class="flex items-center justify-around mb-3 text-center">
            <div>
              <div id="mg-td-yards" class="font-varsity text-4xl text-green-300">0</div>
              <div class="text-xs text-white/50">yards (to TD)</div>
            </div>
            <div>
              <div id="mg-td-tds" class="font-varsity text-4xl text-yellow-300">0</div>
              <div class="text-xs text-white/50">touchdowns</div>
            </div>
            <div>
              <div id="mg-td-timer" class="font-varsity text-4xl text-white/60">${td.active ? td.timeLeft : 20}</div>
              <div class="text-xs text-white/50">seconds</div>
            </div>
            <div>
              <div id="mg-td-best" class="font-varsity text-4xl text-white/40">${td.bestTds}</div>
              <div class="text-xs text-white/50">best TDs</div>
            </div>
          </div>
          <div class="relative mb-3 h-5 bg-white/10 rounded-full overflow-hidden">
            <div class="absolute inset-0 flex items-center justify-center text-xs text-white/30 font-varsity">FIELD PROGRESS</div>
          </div>
          <div class="flex items-center gap-2 mb-1">
            <button id="mg-td-btn" onclick="MiniGames.startTwoDrill()"
              class="flex-1 py-3 rounded font-varsity text-base tracking-wide bg-green-700 hover:bg-green-600 text-white transition">
              ${tdBtnText}
            </button>
            <div id="mg-td-gain" class="font-varsity text-green-300 w-16 text-center text-sm" style="opacity:0;transition:opacity 0.4s"></div>
          </div>
          <div id="mg-td-res" class="text-center font-varsity text-base text-green-300 min-h-[1.4rem]"></div>
        </div>

        <!-- Field Goal Kick -->
        <div class="rounded-xl border border-byu-blue bg-byu-navy/70 p-4 shadow-lg">
          <h3 class="font-varsity text-xl tracking-wide border-b border-white/20 pb-2 mb-3">ğŸˆ FIELD GOAL KICK</h3>
          <div class="flex justify-center mb-3">
            <svg width="110" height="72" viewBox="0 0 110 72" aria-label="Goal posts">
              <rect x="0" y="66" width="110" height="5" fill="#2d5a27" rx="1"/>
              <rect x="38" y="8" width="4" height="58" fill="#FFD700"/>
              <rect x="68" y="8" width="4" height="58" fill="#FFD700"/>
              <rect x="34" y="30" width="42" height="4" fill="#FFD700"/>
              <rect x="52" y="34" width="6" height="32" fill="#C8A800"/>
              <rect x="42" y="10" width="26" height="18" fill="rgba(0,200,80,0.14)" rx="1"/>
              <text x="55" y="23" text-anchor="middle" font-size="8" fill="rgba(0,220,80,0.7)" font-family="monospace">GOOD</text>
            </svg>
          </div>
          <p class="text-xs text-white/50 text-center mb-2">Click <strong class="text-white/70">START KICK</strong> then click again to kick â€” land in the green zone!</p>
          <div class="relative h-7 bg-white/10 rounded-full overflow-hidden mb-3 select-none">
            <div class="absolute top-0 bottom-0 rounded" style="left:35%;width:30%;background:rgba(0,200,80,0.28)"></div>
            <div id="mg-fg-ind" class="absolute top-1 bottom-1 w-2.5 bg-yellow-400 rounded-full shadow" style="left:0%;transform:translateX(-50%);transition:none"></div>
          </div>
          <div class="flex items-center gap-2 mb-2">
            <button id="mg-fg-btn" onclick="MiniGames.kickFG()"
              class="flex-1 py-2 rounded font-varsity text-sm tracking-wide bg-byu-blue hover:bg-blue-400 text-white transition">
              ${fgBtnText}
            </button>
            <span class="text-xs text-white/50 whitespace-nowrap">Score: <span id="mg-fg-score" class="text-yellow-300 font-bold">${fg.wins}/${fg.total}</span></span>
          </div>
          <div id="mg-fg-res" class="text-center font-varsity text-base text-yellow-300 min-h-[1.4rem]"></div>
        </div>

        <!-- Free Throw -->
        <div class="rounded-xl border border-orange-500/40 bg-byu-navy/70 p-4 shadow-lg">
          <h3 class="font-varsity text-xl tracking-wide border-b border-white/20 pb-2 mb-3">ğŸ€ FREE THROW</h3>
          <div class="flex justify-center mb-3">
            <svg width="110" height="72" viewBox="0 0 110 72" aria-label="Basketball hoop">
              <rect x="0" y="67" width="110" height="4" fill="#8B6914" rx="1"/>
              <rect x="74" y="6" width="28" height="20" fill="none" stroke="#999" stroke-width="2" rx="1"/>
              <rect x="64" y="22" width="12" height="3" fill="#999"/>
              <ellipse cx="55" cy="30" rx="17" ry="4" fill="none" stroke="#FF6B00" stroke-width="3"/>
              <path d="M38 30 Q40 48 55 53 Q70 48 72 30" fill="none" stroke="rgba(255,255,255,0.45)" stroke-width="1.5" stroke-dasharray="3,2"/>
              <circle cx="18" cy="56" r="9" fill="#FF6B00"/>
              <path d="M18 47 Q24 52 18 65" stroke="#000" stroke-width="1" fill="none"/>
              <path d="M9 56 Q14 50 27 56" stroke="#000" stroke-width="1" fill="none"/>
            </svg>
          </div>
          <p class="text-xs text-white/50 text-center mb-2">Click <strong class="text-white/70">START SHOOTING</strong> then click again â€” hit the sweet spot for a swish!</p>
          <div class="relative h-7 bg-white/10 rounded-full overflow-hidden mb-3 select-none">
            <div class="absolute top-0 bottom-0 rounded" style="left:35%;width:30%;background:rgba(255,107,0,0.28)"></div>
            <div id="mg-ft-ind" class="absolute top-1 bottom-1 w-2.5 bg-orange-400 rounded-full shadow" style="left:0%;transform:translateX(-50%);transition:none"></div>
          </div>
          <div class="flex items-center gap-2 mb-2">
            <button id="mg-ft-btn" onclick="MiniGames.shootFT()"
              class="flex-1 py-2 rounded font-varsity text-sm tracking-wide bg-orange-600 hover:bg-orange-500 text-white transition">
              ${ftBtnText}
            </button>
            <span class="text-xs text-white/50 whitespace-nowrap">Score: <span id="mg-ft-score" class="text-orange-300 font-bold">${ft.wins}/${ft.total}</span></span>
          </div>
          <div id="mg-ft-res" class="text-center font-varsity text-base text-orange-300 min-h-[1.4rem]"></div>
        </div>

        <!-- Hail Mary Pass -->
        <div class="rounded-xl border border-green-500/40 bg-byu-navy/70 p-4 shadow-lg">
          <h3 class="font-varsity text-xl tracking-wide border-b border-white/20 pb-2 mb-3">ğŸˆ HAIL MARY PASS</h3>
          <p class="text-xs text-white/50 text-center mb-3">Click as fast as you can in <strong class="text-white/70">5 seconds</strong>! More throws = bigger bonus!</p>
          <div class="flex items-center justify-around mb-3 text-center">
            <div><div id="mg-hm-clicks" class="font-varsity text-4xl text-green-300">${_st.hm.active ? _st.hm.clicks : 0}</div><div class="text-xs text-white/50">throws</div></div>
            <div><div id="mg-hm-timer" class="font-varsity text-4xl text-yellow-300">${_st.hm.active ? _st.hm.timeLeft : 5}</div><div class="text-xs text-white/50">seconds</div></div>
            <div><div id="mg-hm-best" class="font-varsity text-4xl text-white/60">${_st.hm.best}</div><div class="text-xs text-white/50">best</div></div>
          </div>
          <div class="flex items-center gap-2 mb-2">
            <button id="mg-hm-btn" onclick="MiniGames.startHailMary()"
              class="flex-1 py-3 rounded font-varsity text-base tracking-wide bg-green-700 hover:bg-green-600 text-white transition">
              ${_st.hm.active ? 'ğŸˆ THROW!' : (_st.hm.total > 0 ? 'â–¶ Play Again' : 'â–¶ START HAIL MARY')}
            </button>
          </div>
          <div class="text-xs text-white/40 text-center mb-2">${[...HM_TIERS].reverse().map(t => `${t.throws} throws: +${t.bonus.toLocaleString()}pts`).join(' &nbsp;Â·&nbsp; ')}</div>
          <div id="mg-hm-res" class="text-center font-varsity text-base text-green-300 min-h-[1.4rem]"></div>
        </div>
      </div>`;
    // Restart animation loops if games were active when tab was re-opened
    if (fg.active) { cancelAnimationFrame(fg.animId); _fgTick(); }
    if (ft.active) { cancelAnimationFrame(ft.animId); _ftTick(); }
  };

  /* â”€â”€ Hail Mary Pass â”€â”€ */
  const startHailMary = () => {
    const g = _st.hm;
    if (g.active) {
      // Each click during the game counts as a throw
      g.clicks++;
      const el = document.getElementById('mg-hm-clicks');
      if (el) el.textContent = g.clicks;
      return;
    }
    g.active = true;
    g.clicks = 0;
    g.timeLeft = 5;
    g.total++;
    const sHm = State.get();
    State.update({ miniGamesPlayed: (sHm.miniGamesPlayed || 0) + 1 });
    Game.checkAchievements();
    const btn = document.getElementById('mg-hm-btn');
    if (btn) btn.textContent = 'ğŸˆ THROW!';
    const res = document.getElementById('mg-hm-res');
    if (res) res.textContent = '';
    const clicksEl = document.getElementById('mg-hm-clicks');
    if (clicksEl) clicksEl.textContent = '0';
    clearInterval(g.timerId);
    g.timerId = setInterval(() => {
      g.timeLeft--;
      const timerEl = document.getElementById('mg-hm-timer');
      if (timerEl) timerEl.textContent = g.timeLeft;
      if (g.timeLeft <= 0) {
        clearInterval(g.timerId);
        g.active = false;
        if (g.clicks > g.best) g.best = g.clicks;
        const tier = HM_TIERS.find(t => g.clicks >= t.throws);
        const bonus = tier ? tier.bonus : 0;
        const msg   = tier ? tier.msg   : 'ğŸ˜… Keep training!';
        if (tier && tier.bonus >= 1000) Sound.prestige();
        else if (tier) Sound.unlock();
        if (bonus) {
          const s = State.get();
          State.update({ points: s.points + bonus, totalPoints: s.totalPoints + bonus });
          UI.updateHUD();
        }
        const resEl = document.getElementById('mg-hm-res');
        if (resEl) resEl.textContent = msg + (bonus ? ` +${bonus} Cougar Pts` : '');
        const bestEl = document.getElementById('mg-hm-best');
        if (bestEl) bestEl.textContent = g.best;
        const btn2 = document.getElementById('mg-hm-btn');
        if (btn2) btn2.textContent = 'â–¶ Play Again';
      }
    }, 1000);
  };

  return { kickFG, shootFT, startHailMary, startTwoDrill, render };
})();

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('DOMContentLoaded', Game.init);
</script>

</body>
</html>
